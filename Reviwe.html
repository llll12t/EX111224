<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Feedback Form</title>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>
<body>
  <h1>แสดงความคิดเห็นและให้คะแนน</h1>
  <form id="feedbackForm">
    <!-- Hidden inputs to store the parameters -->
    <input type="hidden" id="idkey" name="idkey">
    <input type="hidden" id="status" name="status">
    <input type="hidden" id="name" name="name">
    <input type="hidden" id="responsible" name="responsible">

    <!-- Display the parameters to the user -->
    <p>ID งาน: <span id="displayIdkey"></span></p>
    <p>ชื่อผู้เกี่ยวข้อง: <span id="displayName"></span></p>
    <p>ชื่อผู้รับผิดชอบ: <span id="displayResponsible"></span></p>
    <p>สถานะ: <span id="displayStatus"></span></p>

    <!-- Input fields for rating and comments -->
    <label for="rating">ให้คะแนน (1-5):</label><br>
    <input type="number" id="rating" name="rating" min="1" max="5" required><br><br>

    <label for="comments">ความคิดเห็น:</label><br>
    <textarea id="comments" name="comments" rows="4" cols="50" required></textarea><br><br>

    <button type="submit">ส่งความคิดเห็น</button>
  </form>

  <script>
    // Initialize LIFF SDK
    liff.init({ liffId: "2006504113-VWYEMlmk" })
      .then(() => {
        // Get query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const idkey = urlParams.get('idkey');
        const status = urlParams.get('status');
        const name = urlParams.get('name');
        const responsible = urlParams.get('responsible');

        // Set hidden input values
        document.getElementById('idkey').value = idkey;
        document.getElementById('status').value = status;
        document.getElementById('name').value = name;
        document.getElementById('responsible').value = responsible;

        // Display values on the form
        document.getElementById('displayIdkey').textContent = idkey;
        document.getElementById('displayName').textContent = name;
        document.getElementById('displayResponsible').textContent = responsible;
        document.getElementById('displayStatus').textContent = status;
      })
      .catch((err) => {
        console.error('LIFF Initialization failed', err);
      });

    // Handle form submission
    document.getElementById('feedbackForm').addEventListener('submit', function(e) {
      e.preventDefault();

      // Collect form data
      const formData = {
        method: 'submitFeedback',
        idkey: document.getElementById('idkey').value,
        status: document.getElementById('status').value,
        name: document.getElementById('name').value,
        responsible: document.getElementById('responsible').value,
        rating: document.getElementById('rating').value,
        comments: document.getElementById('comments').value,
        userId: liff.getContext().userId || ''
      };

      // Send data to Google Apps Script
      fetch('https://script.google.com/macros/s/AKfycbxJoSNrT4OAaEdwusbpVN9tid-kVkVWtBfP7XhXfy_fXUcgeYl2HZSndC95SuNDFVRxAg/exec', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('ขอบคุณสำหรับความคิดเห็นของคุณ!');
          liff.closeWindow();
        } else {
          alert('เกิดข้อผิดพลาดในการส่งความคิดเห็น: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('เกิดข้อผิดพลาดในการส่งความคิดเห็น');
      });
    });
  </script>
</body>
</html>
