<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการงาน</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/liff.js"></script>
    <style>
        .bg-green-custom {
            background: #078274;
        }
        .disabled-button {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .bg-green {
            background: #078274;
        }
        .border-green {
            border: 2px solid #078274;
            border-radius: 10px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-5xl mx-auto">
        <!-- Tab Navigation -->
        <div class="mb-4">
            <ul class="flex border-b">
                <li class="-mb-px mr-1">
                    <a href="#tab1" class="bg-white inline-block py-2 px-4 text-green-500 font-semibold" onclick="openTab(event, 'tab1')">จัดการข้อมูลการสั่งซื้อ</a>
                </li>
                <li class="mr-1">
                    <a href="#tab2" class="bg-white inline-block py-2 px-4 text-green-500 font-semibold" onclick="openTab(event, 'tab2')">จัดการข้อมูลการดำเนินการ</a>
                </li>
            </ul>
        </div>

        <!-- Tab Content -->
        <div id="tab1" class="tab-content">
            <!-- เนื้อหาจากโค้ดที่ 1 -->
            <div class="bg-green-custom rounded-lg p-4 mb-4">
                <!-- Filter Section -->
                <div class="flex flex-wrap -mx-2">
                    <div class="p-2 w-1/3">
                        <input type="text" id="filter-name-1" placeholder="ค้นหาตามชื่อ" class="w-full border px-2 py-1 rounded-lg" oninput="applyFilters1()">
                    </div>
                    <div class="p-2 w-1/3">
                        <select id="filter-status-1" class="w-full border px-2 py-1 rounded-lg" onchange="applyFilters1()">
                            <option value="">สถานะ</option>
                            <option value="รอดำเนินการ">รอดำเนินการ</option>
                            <option value="ปฏิเสธ">ปฏิเสธ</option>
                            <option value="กำลังดำเนินการ">กำลังดำเนินการ</option>
                            <option value="เสร็จสิ้น">เสร็จสิ้น</option>
                        </select>
                    </div>
                    <div class="p-2 w-1/3">
                        <select id="sort-order-1" class="w-full border px-2 py-1 rounded-lg" onchange="applyFilters1()">
                            <option value="newest">ใหม่สุด</option>
                            <option value="oldest">เก่าสุด</option>
                        </select>
                    </div>
                </div> 
                <!-- เนื้อหาอื่นๆ ของโค้ดที่ 1 -->
                <!-- ... -->
            </div>

            <!-- Card Container สำหรับงานที่ยังไม่เสร็จสิ้น -->
            <div id="card-container-1" class="grid grid-cols-1 gap-4 mb-8">
                <!-- Card จะถูกแทรกที่นี่ -->
            </div>

            <!-- ตารางสำหรับงานที่เสร็จสิ้น -->
            <div id="completed-tasks-section-1" class="mb-8">
                <h2 class="text-lg font-semibold mb-4">งานที่ดำเนินการสำเร็จ</h2>
                <table id="completed-table-1" class="min-w-full text-xs bg-white rounded-lg">
                    <thead>
                        <tr class="text-green-custom text-sm">
                             <th class="py-2 px-4 border">วันที่</th>
                             <th class="py-2 px-4 border">ชื่อ</th>
                             <th class="py-2 px-4 border">สถานะ</th>
                             <th class="py-2 px-4 border">การดำเนินการ</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm"></tbody>
                </table>
            </div>

            <!-- Loading Message -->
            <div id="loading-message-1" class="text-center text-gray-500 mt-4" style="display: none;">กำลังโหลดข้อมูล...</div>

            <!-- Pagination Controls -->
            <div id="pagination-controls-1" class="flex justify-center mt-4 space-x-2">
                <button id="prev-page-1" class="bg-gray-300 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-400" onclick="changePage1(currentPage1 - 1)">ก่อนหน้า</button>
                <div id="page-numbers-1" class="flex space-x-1">
                    <!-- ตัวเลขหน้าจะถูกสร้างที่นี่ -->
                </div>
                <button id="next-page-1" class="bg-gray-300 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-400" onclick="changePage1(currentPage1 + 1)">ถัดไป</button>
            </div>

            <!-- Edit Modal -->
            <div id="edit-modal-1" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
                <div class="bg-white p-6 rounded-lg w-full max-w-md">
                    <h2 class="text-xl mb-4">แก้ไขข้อมูลสถานะ</h2>
                    <form id="edit-form-1">
                        <input type="hidden" id="edit-idkey-1">
                        
                        <div class="mb-4">
                            <label for="edit-status-1" class="block mb-1">สถานะ</label>
                            <select id="edit-status-1" class="w-full border p-2 rounded-lg">
                                <option value="เลื่อนนัด">เลื่อนนัด</option>
                                <option value="ยกเลิก">ยกเลิก</option>
                                <option value="ข้อมูลไม่ถูกต้อง">ข้อมูลไม่ถูกต้อง</option>
                                <option value="ผิดพลาด">ผิดพลาด</option>
                                <option value="อื่นๆ">อื่นๆ</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="edit-responsible-1" class="block mb-1">ผู้รับผิดชอบ</label>
                            <input type="text" id="edit-responsible-1" class="w-full border p-2 rounded-lg" required>
                        </div>

                        <div class="mb-4">
                            <label for="edit-admin-note-1" class="block mb-1">หมายเหตุ Admin</label>
                            <textarea id="edit-admin-note-1" class="w-full border p-2 rounded-lg" ></textarea>
                        </div>

                        <div class="flex justify-end mt-4 space-x-2">
                            <button type="button" class="bg-red-500 text-white p-3 w-1/3 rounded-lg hover:bg-red-700"
                                onclick="closeModal1()">ยกเลิก</button>
                            <button type="submit"
                                class="bg-blue-500 text-white p-3 w-2/3 rounded-lg hover:bg-blue-700">บันทึก</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- รวมสคริปต์เฉพาะสำหรับแท็บที่ 1 -->
            <script>
                // สคริปต์จากโค้ดที่ 1
                // เปลี่ยนชื่อฟังก์ชันและตัวแปรให้ไม่ซ้ำกับโค้ดที่ 2

                const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxJoSNrT4OAaEdwusbpVN9tid-kVkVWtBfP7XhXfy_fXUcgeYl2HZSndC95SuNDFVRxAg/exec';
                const LIFF_ID = '2006504113-lVYLV6Xe';

                let tableData1 = []; 
                let filteredData1 = [];
                let completedData1 = [];
                let currentUserId1 = ''; // ตัวแปรเก็บ userId ปัจจุบัน
                let currentPage1 = 1;
                const rowsPerPage1 = 10;
                let totalPages1 = 1;
                let isSubmitting1 = false; // ตัวแปรเพื่อป้องกันการส่งข้อมูลซ้ำใน takeJob

                /**
                 * ฟังก์ชันเริ่มต้น LIFF
                 */
                async function initializeLiff1() {
                    try {
                        await liff.init({ liffId: LIFF_ID });
                        if (liff.isLoggedIn()) {
                            getUserProfile1();
                        } else {
                            liff.login(); // ทำการล็อกอินถ้ายังไม่ได้ล็อกอิน
                        }
                    } catch (error) {
                        console.error('LIFF Initialization failed', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถเริ่มต้น LIFF ได้' });
                    }
                }

                /**
                 * ฟังก์ชันดึงข้อมูลโปรไฟล์ผู้ใช้จาก LIFF
                 */
                async function getUserProfile1() {
                    try {
                        const profile = await liff.getProfile();
                        const userId = profile.userId;
                        currentUserId1 = userId;
                        console.log('User ID:', userId); // สำหรับการดีบัก
                        fetchData1(userId); // ดึงและกรองข้อมูลตาม userId
                    } catch (error) {
                        console.error('Error getting profile data:', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถดึงข้อมูลโปรไฟล์ผู้ใช้ได้' });
                    }
                }

                /**
                 * ฟังก์ชันดึงข้อมูลจาก Google Sheets
                 * @param {string} userId - userId ของผู้ใช้
                 */
                async function fetchData1(userId) {
                    document.getElementById('loading-message-1').style.display = 'block';
                    try {
                        const response = await fetch(`${WEB_APP_URL}?sheet=Data`);
                        const result = await response.json();
                        if (result.success) {
                            tableData1 = result.data;
                            console.log('Data fetched:', tableData1); // สำหรับการดีบัก
                            applyFilters1(); // แสดงข้อมูลหลังจากดึงมาเรียบร้อยแล้ว
                        } else {
                            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                        }
                    } catch (error) {
                        console.error('Error fetching data:', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถโหลดข้อมูลได้' });
                    } finally {
                        document.getElementById('loading-message-1').style.display = 'none';
                    }
                }

                /**
                 * ฟังก์ชันแสดงข้อมูลในรูปแบบ Card
                 */
                function displayCards1(data) {
                    const cardContainer = document.querySelector('#card-container-1'); // Container สำหรับ card
                    cardContainer.innerHTML = ''; // ล้างเนื้อหาเดิม

                    if (data.length === 0) {
                        cardContainer.innerHTML = '<p class="text-center text-gray-500">ไม่มีข้อมูลที่จะแสดง</p>';
                        return;
                    }

                    data.forEach(row => {
                        // สร้าง card container
                        const card = document.createElement('div');
                        card.className = 'border border-gray-300 rounded-lg p-4 mb-4 shadow-md bg-white';

                        // สร้าง grid สำหรับแถวที่ 1 (วันที่, ชื่อ, สถานะ)
                        const topRow = document.createElement('div');
                        topRow.className = 'grid grid-cols-3 gap-4 mb-4';

                        // วันที่
                        const dateDiv = document.createElement('div');
                        dateDiv.className = 'text-xs text-gray-500';
                        dateDiv.textContent = 'วันที่';
                        const dateValue = document.createElement('div');
                        dateValue.className = 'text-sm text-gray-800';
                        dateValue.textContent = formatDate1(row.Date);

                        // ชื่อ
                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'text-xs text-gray-500';
                        nameDiv.textContent = 'ชื่อ';
                        const nameValue = document.createElement('div');
                        nameValue.className = 'text-sm text-gray-800';
                        nameValue.textContent = row.Name;

                        // สถานะ
                        const statusDiv = document.createElement('div');
                        statusDiv.className = 'text-xs text-gray-500';
                        statusDiv.textContent = 'สถานะ';
                        const statusValue = document.createElement('div');
                        statusValue.className = 'text-sm text-gray-800';
                        statusValue.textContent = translateStatus1(row.Status);

                        // เพิ่มส่วนต่างๆ ลงใน topRow
                        const dateContainer = document.createElement('div');
                        dateContainer.appendChild(dateDiv);
                        dateContainer.appendChild(dateValue);
                        topRow.appendChild(dateContainer);

                        const nameContainer = document.createElement('div');
                        nameContainer.appendChild(nameDiv);
                        nameContainer.appendChild(nameValue);
                        topRow.appendChild(nameContainer);

                        const statusContainer = document.createElement('div');
                        statusContainer.appendChild(statusDiv);
                        statusContainer.appendChild(statusValue);
                        topRow.appendChild(statusContainer);

                        // สร้าง grid สำหรับแถวที่ 2 (ปุ่มต่างๆ)
                        const bottomRow = document.createElement('div');
                        bottomRow.className = 'grid grid-cols-3 gap-4';

                        // ปุ่มรายละเอียด
                        const detailsButton = document.createElement('button');
                        detailsButton.className = 'bg-purple-700 text-white py-2 px-4 rounded-lg hover:bg-purple-800 transition w-full';
                        detailsButton.textContent = 'รายละเอียด';
                        detailsButton.onclick = () => viewDetails1(row.IDkey);
                        detailsButton.setAttribute('aria-label', `ดูรายละเอียดของงาน ${row.Name}`);

                        // ปุ่มแจ้งเรื่อง
                        const editButton = document.createElement('button');
                        editButton.className = 'bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition w-full';
                        editButton.textContent = 'แจ้งเรื่อง';
                        editButton.onclick = () => openEditModal1(row.IDkey);

                        // ปุ่มยืนยัน
                        const confirmButton = document.createElement('button');
                        const isDisabled = row.Status === 'กำลังดำเนินการ' || row.Status === 'เสร็จสิ้น';
                        confirmButton.className = `bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition w-full ${isDisabled ? 'disabled-button' : ''}`;
                        confirmButton.textContent = 'ยืนยัน';
                        if (!isDisabled) {
                            confirmButton.onclick = () => takeJob1(row.IDkey);
                        }
                        confirmButton.disabled = isDisabled;
                        if (isDisabled) {
                            confirmButton.classList.add('disabled-button');
                        }

                        // เพิ่มปุ่มทั้งหมดลงใน bottomRow
                        bottomRow.appendChild(detailsButton);
                        bottomRow.appendChild(editButton);
                        bottomRow.appendChild(confirmButton);

                        // นำ topRow และ bottomRow มารวมกันใน card
                        card.appendChild(topRow);
                        card.appendChild(bottomRow);

                        // เพิ่ม card ลงใน container
                        cardContainer.appendChild(card);
                    });
                }

                /**
                 * ฟังก์ชันแปลสถานะจากภาษาอังกฤษเป็นภาษาไทย
                 */
                function translateStatus1(status) {
                    switch(status.toLowerCase()) {
                        case 'อนุมัติ': return 'อนุมัติ';
                        case 'ยกเลิก': return 'ยกเลิก';
                        case 'ปฏิเสธ': return 'ปฏิเสธ';
                        case 'กำลังดำเนินการ': return 'กำลังดำเนินการ';
                        case 'เสร็จสิ้น': return 'เสร็จสิ้น';
                        default: return status;
                    }
                }

                /**
                 * ฟังก์ชันแปลงวันที่เป็นรูปแบบ DD/MM/YYYY HH:mm
                 */
                function formatDate1(dateString) {
                    const date = new Date(dateString);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${day}/${month}/${year} ${hours}:${minutes}`;
                }

                /**
                 * ฟังก์ชันดูรายละเอียดข้อมูล
                 */
                function viewDetails1(idkey) {
                    const row = tableData1.find(row => row.IDkey === idkey);
                    if (row) {
                        Swal.fire({
                            title: 'รายละเอียด',
                            html: `
                                <div style="text-align: left;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr><td style="border: 1px solid #ddd; padding: 8px; width: 40%;"><b>ID Key:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.IDkey}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>ชื่อ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Name}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>ที่อยู่:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Address}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>Map Link:</b></td><td style="border: 1px solid #ddd; padding: 8px;"><a href="${row.Maplink}" target="_blank">เปิดแผนที่</a></td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>ชื่อหมู่บ้าน:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Village}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>วันที่:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${formatDate1(row.Date)}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>รายละเอียด:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Detail}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>หมายเหตุ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Note}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>เบอร์ติดต่อ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Contact}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>การชำระเงิน:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Payment}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>สถานะ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${translateStatus1(row.Status)}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>ผู้รับผิดชอบ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Responsible}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>Admin:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Admin}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>หมายเหตุ Admin:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.adminNote}</td></tr>
                                    </table>
                                </div>
                            `,
                            confirmButtonText: 'ปิด'
                        });
                    }
                }

                /**
                 * ฟังก์ชันเปิดโมดอลสำหรับแก้ไขข้อมูล
                 */
                function openEditModal1(idkey) {
                    const row = tableData1.find(row => row.IDkey === idkey);
                    if (row) {
                        document.getElementById('edit-idkey-1').value = row.IDkey;
                        document.getElementById('edit-status-1').value = row.Status;
                        document.getElementById('edit-responsible-1').value = row.Responsible;
                        document.getElementById('edit-admin-note-1').value = row.adminNote;
                        document.getElementById('edit-modal-1').classList.remove('hidden');
                    }
                }

                /**
                 * ฟังก์ชันปิดโมดอล
                 */
                function closeModal1() {
                    document.getElementById('edit-modal-1').classList.add('hidden');
                }

                /**
                 * ฟังก์ชันจัดการฟอร์มแก้ไขข้อมูล
                 */
                document.getElementById('edit-form-1').addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const submitButton = this.querySelector("button[type=submit]");
                    const originalText = submitButton.textContent;
                    submitButton.disabled = true;
                    submitButton.textContent = 'กำลังอัพเดท...';

                    const idkey = document.getElementById('edit-idkey-1').value;
                    const status = document.getElementById('edit-status-1').value;
                    const responsible = document.getElementById('edit-responsible-1').value.trim();
                    const adminNote = document.getElementById('edit-admin-note-1').value.trim();

                    if (!idkey || !status || !responsible || !adminNote) { // เพิ่มเงื่อนไขการตรวจสอบขั้นต่ำ
                        Swal.fire({ icon: 'warning', title: 'คำเตือน', text: 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน' });
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                        return;
                    }

                    try {
                        const response = await fetch(WEB_APP_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `method=updateOrder&idkey=${encodeURIComponent(idkey)}&status=${encodeURIComponent(status)}&responsible=${encodeURIComponent(responsible)}&adminNote=${encodeURIComponent(adminNote)}`
                        });
                        const result = await response.json();

                        if (result.success) {
                            Swal.fire({ title: 'สำเร็จ', text: result.message, icon: 'success' });
                            closeModal1();
                            fetchData1(currentUserId1); // รีเฟรชข้อมูลหลังจากอัปเดต
                        } else {
                            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                        }
                    } catch (error) {
                        console.error('Error updating data:', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    }
                });

                /**
                 * ฟังก์ชันรับงาน
                 */
                async function takeJob1(idkey) {
                    if (isSubmitting1) {
                        // หากกำลังส่งข้อมูลอยู่แล้ว ไม่ทำอะไร
                        return;
                    }
                    isSubmitting1 = true; // ตั้งค่าว่ากำลังส่งข้อมูลอยู่

                    Swal.fire({
                        title: 'ยืนยันการรับงาน?',
                        text: `คุณต้องการเปลี่ยนสถานะของ Order ID: ${idkey} เป็น "กำลังดำเนินการ" ใช่หรือไม่?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'ใช่, รับงาน',
                        cancelButtonText: 'ยกเลิก'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            // ปิด SweetAlert2 เพื่อแสดงข้อความกำลังอัพเดท
                            Swal.fire({
                                title: 'กำลังอัพเดท...',
                                allowOutsideClick: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });

                            try {
                                const response = await fetch(WEB_APP_URL, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                    body: `method=takeJob&idkey=${encodeURIComponent(idkey)}`
                                });
                                const resultData = await response.json();

                                if (resultData.success) {
                                    Swal.fire({ title: 'สำเร็จ', text: resultData.message, icon: 'success' });
                                    fetchData1(currentUserId1);
                                } else {
                                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: resultData.message });
                                }
                            } catch (error) {
                                console.error('Error updating data:', error);
                                Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                            } finally {
                                isSubmitting1 = false; // รีเซ็ตตัวแปรหลังจากส่งข้อมูลเสร็จสิ้น
                            }
                        } else {
                            isSubmitting1 = false; // รีเซ็ตตัวแปรถ้าผู้ใช้ยกเลิก
                        }
                    });
                }

                /**
                 * ฟังก์ชันกรองข้อมูล
                 */
                function applyFilters1() {
                    const filterName = document.getElementById('filter-name-1').value.toLowerCase();
                    const filterStatus = document.getElementById('filter-status-1').value.toLowerCase();
                    const sortOrder = document.getElementById('sort-order-1').value;

                    // Filter by name, status, and userId
                    filteredData1 = tableData1.filter(row => {
                        const matchesName = row.Name.toLowerCase().includes(filterName);
                        const matchesStatus = filterStatus ? row.Status.toLowerCase() === filterStatus : true;
                        const matchesUserId = row.UserIDresponsible === currentUserId1; // เงื่อนไขกรองตาม userId
                        return matchesName && matchesStatus && matchesUserId;
                    });

                    // แยกข้อมูลเป็นสองกลุ่ม: กำลังดำเนินการและเสร็จสิ้น
                    const pendingTasks = filteredData1.filter(row => row.Status.toLowerCase() !== 'เสร็จสิ้น');
                    const completedTasks = tableData1.filter(row => row.Status.toLowerCase() === 'เสร็จสิ้น');

                    // เรียงข้อมูลตามตัวเลือกการเรียงลำดับ
                    if (sortOrder === 'newest') {
                        pendingTasks.sort((a, b) => new Date(b.Date) - new Date(a.Date));
                        completedTasks.sort((a, b) => new Date(b.Date) - new Date(a.Date));
                    } else if (sortOrder === 'oldest') {
                        pendingTasks.sort((a, b) => new Date(a.Date) - new Date(b.Date));
                        completedTasks.sort((a, b) => new Date(a.Date) - new Date(b.Date));
                    }

                    // คำนวณจำนวนหน้าทั้งหมดสำหรับการแบ่งหน้า
                    totalPages1 = Math.ceil(pendingTasks.length / rowsPerPage1);
                    currentPage1 = 1;
                    setupPagination1();

                    // แสดงข้อมูลหน้าปัจจุบันสำหรับงานที่กำลังดำเนินการ
                    const paginatedData = paginateData1(pendingTasks, currentPage1);
                    displayCards1(paginatedData);

                    // แสดงข้อมูลตารางสำหรับงานที่เสร็จสิ้น
                    displayCompletedTable1(completedTasks);
                }

                /**
                 * ฟังก์ชันตั้งค่าการแบ่งหน้า
                 */
                function setupPagination1() {
                    const pageNumbersContainer = document.getElementById('page-numbers-1');
                    pageNumbersContainer.innerHTML = '';

                    for (let i = 1; i <= totalPages1; i++) {
                        const pageButton = document.createElement('button');
                        pageButton.innerText = i;
                        pageButton.className = `px-3 py-1 rounded-lg ${i === currentPage1 ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`;
                        pageButton.onclick = () => changePage1(i);
                        pageNumbersContainer.appendChild(pageButton);
                    }

                    // ปรับสถานะปุ่มก่อนหน้าและถัดไป
                    document.getElementById('prev-page-1').disabled = currentPage1 === 1;
                    document.getElementById('next-page-1').disabled = currentPage1 === totalPages1;
                }

                /**
                 * ฟังก์ชันเปลี่ยนหน้า
                 * @param {number} page - หน้าที่ต้องการเปลี่ยนไป
                 */
                function changePage1(page) {
                    if (page < 1 || page > totalPages1) return;
                    currentPage1 = page;
                    setupPagination1();

                    // แสดงข้อมูลหน้าปัจจุบันสำหรับงานที่กำลังดำเนินการ
                    const pendingTasks = filteredData1.filter(row => row.Status.toLowerCase() !== 'เสร็จสิ้น');
                    const paginatedData = paginateData1(pendingTasks, currentPage1);
                    displayCards1(paginatedData);
                }

                /**
                 * ฟังก์ชันแบ่งข้อมูลตามหน้า
                 * @param {Array} data - ข้อมูลทั้งหมด
                 * @param {number} page - หน้าปัจจุบัน
                 * @returns {Array} - ข้อมูลที่อยู่ในหน้าปัจจุบัน
                 */
                function paginateData1(data, page) {
                    const start = (page - 1) * rowsPerPage1;
                    const end = start + rowsPerPage1;
                    return data.slice(start, end);
                }

                /**
                 * ฟังก์ชันแสดงข้อมูลในรูปแบบตารางสำหรับงานที่เสร็จสิ้น
                 */
                function displayCompletedTable1(data) {
                    const tableBody = document.querySelector('#completed-table-1 tbody');
                    tableBody.innerHTML = '';

                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="py-2 px-4 border text-center text-gray-500">ไม่มีงานที่ดำเนินการสำเร็จ</td></tr>';
                        return;
                    }

                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="py-2 px-4 border text-center">${formatDate1(row.Date)}</td>
                            <td class="py-2 px-4 border text-center">${row.Name}</td>
                            <td class="py-2 px-4 border text-center">${translateStatus1(row.Status)}</td>
                            <td class="flex flex-between text-xs py-2 px-4 border text-center">
                                <button class="bg-purple-700 text-white py-1 px-3 rounded-lg hover:bg-purple-800 transition" onclick="viewDetails1('${row.IDkey}')">รายละเอียด</button>
                                <button class="bg-yellow-500 text-white py-1 px-3 rounded-lg hover:bg-yellow-600 transition" onclick="openEditModal1('${row.IDkey}')">แจ้งเรื่อง</button>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                }

                /**
                 * ฟังก์ชันเริ่มต้นเมื่อโหลดหน้า
                 */
                window.onload = function() {
                    initializeLiff1(); // เริ่มต้น LIFF สำหรับแท็บที่ 1

                    // เพิ่ม Event Listeners สำหรับฟิลเตอร์ที่ยังเหลืออยู่
                    document.getElementById('filter-name-1').addEventListener('input', applyFilters1);
                    document.getElementById('filter-status-1').addEventListener('change', applyFilters1);
                    document.getElementById('sort-order-1').addEventListener('change', applyFilters1);
                };
            </script>
        </div>

        <div id="tab2" class="tab-content hidden">
            <!-- เนื้อหาจากโค้ดที่ 2 -->
            <div class="w-full max-w-md mb-4">
                <!-- Filter Section จากโค้ดที่ 2 -->
                <div class="bg-green rounded-lg p-4 mb-4">
                    <div class="flex flex-wrap gap-4">
                        <select id="filter-status-2" onchange="applyFilters2()"
                            class="w-full sm:w-auto flex-1 border p-2 rounded-lg">
                            <option value="">ทุกสถานะ</option>
                            <option value="เริ่มงาน">เริ่มงาน</option>
                            <option value="กำลังดำเนินการ">กำลังดำเนินการ</option>
                            <option value="ดำเนินการสำเร็จ">ดำเนินการสำเร็จ</option>
                            <option value="อนุมัติ">อนุมัติ</option>
                            <option value="รอดำเนินการ">รอดำเนินการ</option>
                            <option value="ปฏิเสธ">ปฏิเสธ</option>
                        </select>
                        <input type="text" id="filter-name-2" placeholder="ค้นหาตามชื่อ"
                            class="w-full sm:w-auto flex-1 border p-2 rounded-lg" oninput="applyFilters2()">
                        <input type="hidden" id="userId-2" placeholder="userId" readonly
                            class="w-full sm:w-auto flex-1 border p-2 rounded-lg bg-gray-100">
                    </div>
                </div>
            </div>

            <!-- Task List Section -->
            <div id="task-list-2" class="bg-white w-full max-w-md p-2">
                <!-- Cards จะถูกแทรกที่นี่ -->
            </div>

            <!-- Completed/Archived Tasks Section -->
            <div id="completed-tasks-2" class="bg-white w-full max-w-md p-2 mt-4">
                <!-- Completed tasks จะถูกแทรกที่นี่ -->
            </div>

            <!-- Loading Message -->
            <div id="loading-message-2" class="text-center text-gray-500 mt-4" style="display: none;">กำลังโหลดข้อมูล...</div>

            <!-- View Details Modal -->
            <div id="view-details-modal-2" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-lg w-full max-w-lg overflow-y-auto max-h-full">
                    <h2 class="text-xl mb-4">รายละเอียดข้อมูล</h2>
                    <div id="details-content-2" class="space-y-2">
                        <!-- ข้อมูลทั้งหมดจะแสดงที่นี่ -->
                    </div>
                    <div class="flex justify-end mt-4 space-x-2">
                        <button type="button" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-700"
                            onclick="closeViewDetailsModal2()">ปิด</button>
                    </div>
                </div>
            </div>

            <!-- Start Job Modal -->
            <div id="start-job-modal-2" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-lg w-full max-w-md overflow-y-auto max-h-full">
                    <h2 class="text-xl mb-4">เริ่มงาน</h2>
                    <form id="start-job-form-2">
                        <input type="hidden" id="start-job-idkey-2">

                        <div class="mb-4">
                            <label for="start-status-2" class="block mb-1">สถานะ</label>
                            <select id="start-status-2" class="w-full border p-2 rounded-lg" required>
                                <option value="เริ่มงาน" selected>เริ่มงาน</option>
                                <option value="ยกเลิก">ยกเลิก</option>
                                <option value="เลื่อน">เลื่อน</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="start-time-inside-2" class="block mb-1">เวลา</label>
                            <input type="datetime-local" id="start-time-inside-2" class="w-full border p-2 rounded-lg" required>
                        </div>

                        <div class="mb-4">
                            <label for="start-inside-note-2" class="block mb-1">หมายเหตุ</label>
                            <textarea id="start-inside-note-2" class="w-full border p-2 rounded-lg"></textarea>
                        </div>

                        <div class="flex justify-end mt-4 space-x-2">
                            <button type="button" class="bg-red-500 text-white p-3 w-1/3 rounded-lg hover:bg-red-700"
                                onclick="closeStartJobModal2()">ยกเลิก</button>
                            <button type="submit"
                                class="bg-blue-500 text-white p-3 w-2/3  rounded-lg hover:bg-blue-700">บันทึก</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Process Job Modal -->
            <div id="process-job-modal-2" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-lg w-full max-w-md overflow-y-auto max-h-full">
                    <h2 class="text-xl mb-4">ดำเนินการ</h2>
                    <form id="process-job-form-2">
                        <input type="hidden" id="process-job-idkey-2">

                        <div class="mb-4">
                            <label for="process-status-2" class="block mb-1">สถานะ</label>
                            <select id="process-status-2" class="w-full border p-2 rounded-lg" required>
                                <option value="กำลังดำเนินการ" selected>กำลังดำเนินการ</option>
                                <option value="ยกเลิก">ยกเลิก</option>
                                <option value="เลื่อน">เลื่อน</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="process-time-process-2" class="block mb-1">เวลา</label>
                            <input type="datetime-local" id="process-time-process-2" class="w-full border p-2 rounded-lg" required>
                        </div>

                        <div class="mb-4">
                            <label for="process-process-note-2" class="block mb-1">หมายเหตุ</label>
                            <textarea id="process-process-note-2" class="w-full border p-2 rounded-lg"></textarea>
                        </div>

                        <div class="flex justify-end mt-4 space-x-2">
                            <button type="button" class="bg-red-500 text-white p-3 w-1/3 rounded-lg hover:bg-red-700"
                                onclick="closeProcessJobModal2()">ยกเลิก</button>
                            <button type="submit"
                                class="bg-blue-500 text-white p-3 w-2/3 rounded-lg hover:bg-blue-700">บันทึก</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Complete Job Modal -->
            <div id="complete-job-modal-2" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-lg w-full max-w-lg overflow-y-auto max-h-full">
                    <h2 class="text-xl mb-4">เสร็จสิ้นงาน</h2>
                    <form id="complete-job-form-2" enctype="multipart/form-data">
                        <input type="hidden" id="complete-job-idkey-2">

                        <div class="mb-4">
                            <label for="complete-status-2" class="block mb-1">สถานะ</label>
                            <select id="complete-status-2" class="w-full border p-2 rounded-md" required>
                                <option value="ดำเนินการสำเร็จ" selected>ดำเนินการสำเร็จ</option>
                                <option value="ยกเลิก">ยกเลิก</option>
                                <option value="เลื่อน">เลื่อน</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="complete-time-compress-2" class="block mb-1">เวลา</label>
                            <input type="datetime-local" id="complete-time-compress-2" class="w-full border p-2 rounded-lg" required>
                        </div>

                        <div class="mb-4">
                            <label for="complete-compress-note-2" class="block mb-1">หมายเหตุ</label>
                            <textarea id="complete-compress-note-2" class="w-full border p-2 rounded-lg"></textarea>
                        </div>

                        <div class="mb-4">
                            <label for="complete-compress-photo-2" class="block mb-1">รูปภาพ (ไม่บังคับ)</label>
                            <input type="file" id="complete-compress-photo-2" accept="image/*" class="w-full border p-2 rounded-lg">
                        </div>

                        <div class="flex justify-end mt-4 space-x-2">
                            <button type="button" class="bg-red-500 text-white p-3 w-1/3 rounded-lg hover:bg-red-700"
                                onclick="closeCompleteJobModal2()">ยกเลิก</button>
                            <button type="submit"
                                class="bg-blue-500 text-white p-3 w-2/3 rounded-lg hover:bg-blue-700">บันทึก</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- รวมสคริปต์เฉพาะสำหรับแท็บที่ 2 -->
            <script>
                // สคริปต์จากโค้ดที่ 2
                // เปลี่ยนชื่อฟังก์ชันและตัวแปรให้ไม่ซ้ำกับโค้ดที่ 1

                let tableData2 = []; 
                let filteredData2 = [];
                let completedData2 = [];
                let currentUserId2 = ''; // ตัวแปรเก็บ userId ปัจจุบัน
                let currentPage2 = 1;
                const rowsPerPage2 = 10;
                let totalPages2 = 1;
                let isSubmitting2 = false; // ตัวแปรเพื่อป้องกันการส่งข้อมูลซ้ำใน takeJob

                /**
                 * ฟังก์ชันเริ่มต้น LIFF
                 */
                async function initializeLiff2() {
                    try {
                        await liff.init({ liffId: LIFF_ID }); // ใช้ LIFF ID เดียวกัน
                        if (liff.isLoggedIn()) {
                            getUserProfile2();
                        } else {
                            liff.login(); // ทำการล็อกอินถ้ายังไม่ได้ล็อกอิน
                        }
                    } catch (error) {
                        console.error('LIFF Initialization failed', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถเริ่มต้น LIFF ได้' });
                    }
                }

                /**
                 * ฟังก์ชันดึงข้อมูลโปรไฟล์ผู้ใช้จาก LIFF
                 */
                async function getUserProfile2() {
                    try {
                        const profile = await liff.getProfile();
                        const userId = profile.userId;
                        currentUserId2 = userId;
                        document.getElementById('userId-2').value = userId; // แสดง userId ใน input field (ถ้าต้องการ)
                        fetchData2(userId); // ส่งค่า userId เพื่อดึงและกรองข้อมูล
                    } catch (error) {
                        console.error('Error getting profile data:', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถดึงข้อมูลโปรไฟล์ผู้ใช้ได้' });
                    }
                }

                /**
                 * ฟังก์ชันดึงข้อมูลจาก Google Sheets
                 * @param {string} userId - userId ของผู้ใช้
                 */
                async function fetchData2(userId) {
                    document.getElementById('loading-message-2').style.display = 'block';
                    try {
                        const response = await fetch(`${WEB_APP_URL}?sheet=Dataservice`);
                        const result = await response.json();
                        if (result.success) {
                            tableData2 = result.data; // เก็บข้อมูลในตัวแปร tableData
                            applyFilters2(); // แสดงข้อมูลหลังจากดึงมาเรียบร้อยแล้ว
                        } else {
                            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                        }
                    } catch (error) {
                        console.error('Error fetching data:', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถโหลดข้อมูลได้' });
                    } finally {
                        document.getElementById('loading-message-2').style.display = 'none';
                    }
                }

                /**
                 * ฟังก์ชันจัดการฟิลเตอร์ข้อมูล และเรียงลำดับข้อมูล
                 * @param {string} userId - userId ของผู้ใช้
                 */
                function applyFilters2(userId = currentUserId2) {
                    const filterStatus = document.getElementById('filter-status-2').value.toLowerCase();
                    const filterName = document.getElementById('filter-name-2').value.toLowerCase();

                    const filteredData = tableData2.filter(row => {
                        const matchesStatus = filterStatus ? row.status.toLowerCase().includes(filterStatus) : true;
                        const matchesName = filterName ? (row.Name || '').toLowerCase().includes(filterName) : true;
                        const matchesUserId = row.useridresponsible === userId; // กรองตาม userId

                        return matchesStatus && matchesName && matchesUserId;
                    });

                    // เรียงลำดับข้อมูลจากวันที่ล่าสุดไปยังเก่า
                    filteredData.sort((a, b) => {
                        const dateA = parseDateDDMMYYYYHHmm2(a.timestamp);
                        const dateB = parseDateDDMMYYYYHHmm2(b.timestamp);
                        return dateB - dateA; // เรียงจากมากไปน้อย (ล่าสุดก่อน)
                    });

                    // รีเซ็ตหน้าปัจจุบันเมื่อมีการกรองใหม่
                    currentPage2 = 1;
                    totalPages2 = Math.ceil(filteredData.length / rowsPerPage2);

                    displayTasks2(filteredData);
                }

                /**
                 * ฟังก์ชันแสดงข้อมูลในรูปแบบการ์ด พร้อมหัวข้อและการแบ่งหน้า
                 */
                function displayTasks2(data) {
                    const taskList = document.getElementById('task-list-2');
                    const completedTasks = document.getElementById('completed-tasks-2');

                    taskList.innerHTML = '';
                    completedTasks.innerHTML = '';

                    // แยกข้อมูลเป็นงานที่ต้องทำและงานที่เสร็จสิ้น
                    const pendingTasks = data.filter(row => !(row.status === 'ดำเนินการสำเร็จ' || row.status === 'เลื่อน' || row.status === 'ปฏิเสธ'));
                    const completedTaskData = data.filter(row => (row.status === 'ดำเนินการสำเร็จ' || row.status === 'เลื่อน' || row.status === 'ปฏิเสธ'));

                    // คำนวณจำนวนหน้าสำหรับงานที่ต้องทำ
                    totalPages2 = Math.ceil(pendingTasks.length / rowsPerPage2);
                    if (currentPage2 > totalPages2) currentPage2 = totalPages2 || 1;

                    // คำนวณจำนวนหน้าสำหรับงานที่เสร็จสิ้น
                    const totalPagesCompleted2 = Math.ceil(completedTaskData.length / rowsPerPage2);
                    let currentPageCompleted2 = 1;
                    if (currentPageCompleted2 > totalPagesCompleted2) currentPageCompleted2 = totalPagesCompleted2 || 1;

                    // สร้างหัวข้อสำหรับงานที่ต้องทำ
                    const taskListHeading = document.createElement('h3');
                    taskListHeading.className = 'text-lg font-semibold mb-2';
                    taskListHeading.textContent = 'งานที่ต้องทำ';
                    taskList.appendChild(taskListHeading);


                    // แสดงงานที่ต้องทำตามหน้าปัจจุบัน
                    const startPending = (currentPage2 - 1) * rowsPerPage2;
                    const endPending = startPending + rowsPerPage2;
                    const tasksToDisplay = pendingTasks.slice(startPending, endPending);

                    tasksToDisplay.forEach(row => {
                        // สร้าง card สำหรับแต่ละงาน
                        const card = document.createElement('div');
                        card.className = 'border-green rounded-lg p-4 mb-4';

                        // สร้าง header div ใช้ grid เพื่อจัดคอลัมน์
                        const header = document.createElement('div');
                        header.className = 'grid grid-cols-3 gap-4 border-b pb-2';

                        // สร้าง container สำหรับสถานะ
                        const statusContainer = document.createElement('div');
                        statusContainer.className = 'flex flex-col items-start';

                        const statusLabel = document.createElement('span');
                        statusLabel.textContent = 'สถานะ';
                        statusLabel.className = 'text-sm text-gray-600 mb-1'; // ข้อความขนาดเล็กและสีเทา

                        const statusSpan = document.createElement('span');
                        statusSpan.textContent = row.status;
                        statusSpan.className = 'font-normal text-base'; // ข้อความขนาดปกติ

                        statusContainer.appendChild(statusLabel);
                        statusContainer.appendChild(statusSpan);

                        // สร้าง container สำหรับชื่อ
                        const nameContainer = document.createElement('div');
                        nameContainer.className = 'flex flex-col items-start';

                        const nameLabel = document.createElement('span');
                        nameLabel.textContent = 'ชื่อ';
                        nameLabel.className = 'text-sm text-gray-600 mb-1'; // ข้อความขนาดเล็กและสีเทา

                        const nameSpan = document.createElement('span');
                        nameSpan.textContent = row.Name || '';
                        nameSpan.className = 'font-normal text-base'; // ข้อความขนาดปกติ

                        nameContainer.appendChild(nameLabel);
                        nameContainer.appendChild(nameSpan);

                        // สร้าง container สำหรับรายละเอียด
                        const detailsContainer = document.createElement('div');
                        detailsContainer.className = 'flex flex-col items-start';

                        const detailsLabel = document.createElement('span');
                        detailsLabel.textContent = 'รายละเอียด';
                        detailsLabel.className = 'text-sm text-gray-600 mb-1'; // ข้อความขนาดเล็กและสีเทา

                        const detailsButton = document.createElement('button');
                        detailsButton.className = 'text-blue-500 underline';
                        detailsButton.textContent = 'เพิ่มเติม';
                        detailsButton.onclick = () => openViewDetailsModal2(row.idkey);

                        detailsContainer.appendChild(detailsLabel);
                        detailsContainer.appendChild(detailsButton);

                        // นำทุกอย่างมาใส่ใน header
                        header.appendChild(statusContainer);
                        header.appendChild(nameContainer);
                        header.appendChild(detailsContainer);

                        // สร้าง actionButtons div ใช้ grid เพื่อจัดปุ่มเป็นคอลัมน์
                        const actionButtons = document.createElement('div');
                        actionButtons.className = 'grid grid-cols-3 gap-4 mt-2';

                        const startButton = document.createElement('button');
                        startButton.className = 'bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition';
                        startButton.textContent = 'เริ่มงาน';
                        startButton.onclick = () => openStartJobModal2(row.idkey);

                        const processButton = document.createElement('button');
                        processButton.className = 'bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition';
                        processButton.textContent = 'ดำเนินงาน';
                        processButton.onclick = () => openProcessJobModal2(row.idkey);

                        const completeButton = document.createElement('button');
                        completeButton.className = 'bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition';
                        completeButton.textContent = 'เสร็จสิ้น';
                        completeButton.onclick = () => openCompleteJobModal2(row.idkey);

                        actionButtons.appendChild(startButton);
                        actionButtons.appendChild(processButton);
                        actionButtons.appendChild(completeButton);

                        // นำ header และ actionButtons มาใส่ใน card
                        card.appendChild(header);
                        card.appendChild(actionButtons);

                        // นำ card ไปใส่ใน taskList
                        taskList.appendChild(card);
                    });

                    // ปุ่มนำทางสำหรับงานที่ต้องทำ
                    if (totalPages2 > 1) {
                        const paginationDiv = document.createElement('div');
                        paginationDiv.className = 'flex justify-center mt-4 space-x-2';

                        const prevButton = document.createElement('button');
                        prevButton.className = 'bg-gray-500 text-white py-1 px-3 rounded-lg';
                        prevButton.textContent = 'ก่อนหน้า';
                        prevButton.disabled = currentPage2 === 1;
                        prevButton.onclick = () => {
                            currentPage2--;
                            displayTasks2(data);
                        };

                        const nextButton = document.createElement('button');
                        nextButton.className = 'bg-gray-500 text-white py-1 px-3 rounded-lg';
                        nextButton.textContent = 'ถัดไป';
                        nextButton.disabled = currentPage2 === totalPages2;
                        nextButton.onclick = () => {
                            currentPage2++;
                            displayTasks2(data);
                        };

                        paginationDiv.appendChild(prevButton);
                        paginationDiv.appendChild(nextButton);

                        taskList.appendChild(paginationDiv);
                    }

                    // สร้างหัวข้อสำหรับงานที่เสร็จสิ้นหรือถูกเลื่อน
                    const completedTasksHeading = document.createElement('h3');
                    completedTasksHeading.className = 'text-lg font-semibold mb-2 mt-4';
                    completedTasksHeading.textContent = 'เลื่อน/สำเร็จ';
                    completedTasks.appendChild(completedTasksHeading);

                    // สร้างหัวข้อเล็กๆ
                    const completedHeader = document.createElement('div');
                    completedHeader.className = 'flex justify-between font-bold mb-2';
                    completedHeader.innerHTML = `
                        <span>สถานะ</span>
                        <span>ชื่อ</span>
                        <span>รายละเอียด</span>
                    `;
                    completedTasks.appendChild(completedHeader);

                    // แสดงงานที่เสร็จสิ้นตามหน้าปัจจุบัน
                    const startCompleted = (currentPage2 - 1) * rowsPerPage2;
                    const endCompleted = startCompleted + rowsPerPage2;
                    const completedToDisplay = completedTaskData.slice(startCompleted, endCompleted);

                    completedToDisplay.forEach(row => {
                        // งานที่เสร็จสิ้นหรือถูกเลื่อน
                        const taskItem = document.createElement('div');
                        taskItem.className = 'flex justify-between py-2';

                        const statusSpan = document.createElement('span');
                        statusSpan.textContent = row.status;

                        const nameSpan = document.createElement('span');
                        nameSpan.textContent = row.Name || '';

                        const detailsButton = document.createElement('button');
                        detailsButton.className = 'text-blue-500';
                        detailsButton.textContent = 'เพิ่มเติม';
                        detailsButton.onclick = () => openViewDetailsModal2(row.idkey);

                        taskItem.appendChild(statusSpan);
                        taskItem.appendChild(nameSpan);
                        taskItem.appendChild(detailsButton);

                        completedTasks.appendChild(taskItem);
                    });

                    // ปุ่มนำทางสำหรับงานที่เสร็จสิ้น
                    if (Math.ceil(completedTaskData.length / rowsPerPage2) > 1) {
                        const paginationDiv = document.createElement('div');
                        paginationDiv.className = 'flex justify-center mt-4 space-x-2';

                        const prevButton = document.createElement('button');
                        prevButton.className = 'bg-gray-500 text-white py-1 px-3 rounded-lg';
                        prevButton.textContent = 'ก่อนหน้า';
                        prevButton.disabled = currentPage2 === 1;
                        prevButton.onclick = () => {
                            currentPage2--;
                            displayTasks2(data);
                        };

                        const nextButton = document.createElement('button');
                        nextButton.className = 'bg-gray-500 text-white py-1 px-3 rounded-lg';
                        nextButton.textContent = 'ถัดไป';
                        nextButton.disabled = currentPage2 === Math.ceil(completedTaskData.length / rowsPerPage2);
                        nextButton.onclick = () => {
                            currentPage2++;
                            displayTasks2(data);
                        };

                        paginationDiv.appendChild(prevButton);
                        paginationDiv.appendChild(nextButton);

                        completedTasks.appendChild(paginationDiv);
                    }
                }

                /**
                 * ฟังก์ชันเปิด Modal สำหรับดูรายละเอียดข้อมูล
                 */
                function openViewDetailsModal2(idkey) {
                    const row = tableData2.find(row => row.idkey === idkey);
                    if (row) {
                        const detailsContent = document.getElementById('details-content-2');
                        detailsContent.innerHTML = `
                            <p><strong>PO:</strong> ${row.idkey}</p>
                            <p><strong>สถานะ:</strong> ${row.status}</p>
                            <p><strong>เวลาเริ่มงาน:</strong> ${formatDateToDDMMYYYYHHmm2(row.timeInside)}</p>
                            <p><strong>หมายเหตุ:</strong> ${row.insideNote || ''}</p>
                            <p><strong>เวลาดำเนินการ:</strong> ${formatDateToDDMMYYYYHHmm2(row.timeProcess)}</p>
                            <p><strong>หมายเหตุ:</strong> ${row.processNote || ''}</p>
                            <p><strong>เวลาเสร็จสิ้น:</strong> ${formatDateToDDMMYYYYHHmm2(row.timeCompress)}</p>
                            <p><strong>หมายเหตุ:</strong> ${row.compressNote || ''}</p>
                            <p><strong>อัพโหลดรูป:</strong> ${row.compressPhoto ? `<a href="${row.compressPhoto}" target="_blank" class="text-blue-500 underline">ดูรูป</a>` : 'ไม่มี'}</p>
                            <p><strong>ชื่อ:</strong> ${row.Name || ''}</p>
                            <p><strong>ชื่อผู้ดูแล:</strong> ${row.Responsible || ''}</p>
                            <p><strong>ผู้มอบหมาย:</strong> ${row.Admin || ''}</p>
                            <p><strong>บันทึกเวลา:</strong> ${formatDateToDDMMYYYYHHmm2(row.timestamp)}</p>
                        `;
                        document.getElementById('view-details-modal-2').classList.remove('hidden');
                    }
                }

                /**
                 * ฟังก์ชันปิด Modal สำหรับดูรายละเอียดข้อมูล
                 */
                function closeViewDetailsModal2() {
                    document.getElementById('view-details-modal-2').classList.add('hidden');
                }

                /**
                 * ฟังก์ชันเปิดโมดอลสำหรับเริ่มงาน
                 */
                function openStartJobModal2(idkey) {
                    const row = tableData2.find(row => row.idkey === idkey);
                    if (row) {
                        document.getElementById('start-job-idkey-2').value = row.idkey;
                        document.getElementById('start-time-inside-2').value = getCurrentDateTimeGMT7_2();
                        document.getElementById('start-inside-note-2').value = row.insideNote || '';
                        document.getElementById('start-status-2').value = 'เริ่มงาน'; // ตั้งค่าสถานะเป็น 'เริ่มงาน'
                        document.getElementById('start-job-modal-2').classList.remove('hidden');
                    }
                }

                /**
                 * ฟังก์ชันปิดโมดอลสำหรับเริ่มงาน
                 */
                function closeStartJobModal2() {
                    document.getElementById('start-job-modal-2').classList.add('hidden');
                }

                /**
                 * ฟังก์ชันจัดการฟอร์มเริ่มงาน
                 */
                document.getElementById('start-job-form-2').addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const submitButton = this.querySelector("button[type=submit]");
                    const originalText = submitButton.textContent;
                    submitButton.disabled = true;
                    submitButton.textContent = 'กำลังอัพเดท...';

                    const idkey = document.getElementById('start-job-idkey-2').value;
                    const status = document.getElementById('start-status-2').value;
                    const timeInside = document.getElementById('start-time-inside-2').value;
                    const insideNote = document.getElementById('start-inside-note-2').value.trim();

                    if (!idkey || !status || !timeInside) { // เพิ่มเงื่อนไขการตรวจสอบขั้นต่ำ
                        Swal.fire({ icon: 'warning', title: 'คำเตือน', text: 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน' });
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                        return;
                    }

                    // แปลงวันที่เป็นรูปแบบ DD/MM/YYYY HH:mm
                    const formattedTimeInside = formatDateForSubmit2(timeInside);

                    try {
                        const response = await fetch(WEB_APP_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `method=startJob&idkey=${encodeURIComponent(idkey)}&timeInside=${encodeURIComponent(formattedTimeInside)}&insideNote=${encodeURIComponent(insideNote)}&status=${encodeURIComponent(status)}`
                        });
                        const result = await response.json();

                        if (result.success) {
                            Swal.fire({ title: 'สำเร็จ', text: result.message, icon: 'success' });
                            closeStartJobModal2();
                            fetchData2(currentUserId2); // รีเฟรชข้อมูลหลังจากอัปเดต
                        } else {
                            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                        }
                    } catch (error) {
                        console.error('Error updating data:', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    }
                });

                /**
                 * ฟังก์ชันเปิดโมดอลสำหรับดำเนินการ
                 */
                function openProcessJobModal2(idkey) {
                    const row = tableData2.find(row => row.idkey === idkey);
                    if (row) {
                        document.getElementById('process-job-idkey-2').value = row.idkey;
                        document.getElementById('process-time-process-2').value = getCurrentDateTimeGMT7_2();
                        document.getElementById('process-process-note-2').value = row.processNote || '';
                        document.getElementById('process-status-2').value = 'กำลังดำเนินการ'; // ตั้งค่าสถานะเป็น 'กำลังดำเนินการ'
                        document.getElementById('process-job-modal-2').classList.remove('hidden');
                    }
                }

                /**
                 * ฟังก์ชันปิดโมดอลสำหรับดำเนินการ
                 */
                function closeProcessJobModal2() {
                    document.getElementById('process-job-modal-2').classList.add('hidden');
                }

                /**
                 * ฟังก์ชันจัดการฟอร์มดำเนินการ
                 */
                document.getElementById('process-job-form-2').addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const submitButton = this.querySelector("button[type=submit]");
                    const originalText = submitButton.textContent;
                    submitButton.disabled = true;
                    submitButton.textContent = 'กำลังอัพเดท...';

                    const idkey = document.getElementById('process-job-idkey-2').value;
                    const status = document.getElementById('process-status-2').value;
                    const timeProcess = document.getElementById('process-time-process-2').value;
                    const processNote = document.getElementById('process-process-note-2').value.trim();

                    if (!idkey || !status || !timeProcess) { // เพิ่มเงื่อนไขการตรวจสอบขั้นต่ำ
                        Swal.fire({ icon: 'warning', title: 'คำเตือน', text: 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน' });
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                        return;
                    }

                    // แปลงวันที่เป็นรูปแบบ DD/MM/YYYY HH:mm
                    const formattedTimeProcess = formatDateForSubmit2(timeProcess);

                    try {
                        const response = await fetch(WEB_APP_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `method=processJob&idkey=${encodeURIComponent(idkey)}&timeProcess=${encodeURIComponent(formattedTimeProcess)}&processNote=${encodeURIComponent(processNote)}&status=${encodeURIComponent(status)}`
                        });
                        const result = await response.json();

                        if (result.success) {
                            Swal.fire({ title: 'สำเร็จ', text: result.message, icon: 'success' });
                            closeProcessJobModal2();
                            fetchData2(currentUserId2); // รีเฟรชข้อมูลหลังจากอัปเดต
                        } else {
                            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                        }
                    } catch (error) {
                        console.error('Error updating data:', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    }
                });

                /**
                 * ฟังก์ชันเปิดโมดอลสำหรับเสร็จสิ้นงาน
                 */
                function openCompleteJobModal2(idkey) {
                    const row = tableData2.find(row => row.idkey === idkey);
                    if (row) {
                        document.getElementById('complete-job-idkey-2').value = row.idkey;
                        document.getElementById('complete-time-compress-2').value = getCurrentDateTimeGMT7_2();
                        document.getElementById('complete-compress-note-2').value = row.compressNote || '';
                        document.getElementById('complete-compress-photo-2').value = ''; // รีเซ็ตไฟล์
                        document.getElementById('complete-status-2').value = 'ดำเนินการสำเร็จ'; // ตั้งค่าสถานะเป็น 'ดำเนินการสำเร็จ'
                        document.getElementById('complete-job-modal-2').classList.remove('hidden');
                    }
                }

                /**
                 * ฟังก์ชันปิดโมดอลสำหรับเสร็จสิ้นงาน
                 */
                function closeCompleteJobModal2() {
                    document.getElementById('complete-job-modal-2').classList.add('hidden');
                }

                /**
                 * ฟังก์ชันจัดการฟอร์มเสร็จสิ้นงาน
                 */
                document.getElementById('complete-job-form-2').addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const submitButton = this.querySelector("button[type=submit]");
                    const originalText = submitButton.textContent;
                    submitButton.disabled = true;
                    submitButton.textContent = 'กำลังอัพเดท...';

                    const idkey = document.getElementById('complete-job-idkey-2').value;
                    const status = document.getElementById('complete-status-2').value;
                    const timeCompress = document.getElementById('complete-time-compress-2').value;
                    const compressNote = document.getElementById('complete-compress-note-2').value.trim();
                    const compressPhotoInput = document.getElementById('complete-compress-photo-2');
                    const compressPhotoFile = compressPhotoInput.files[0];
                    let compressPhotoData = '';

                    if (compressPhotoFile) {
                        // อ่านไฟล์เป็น base64
                        compressPhotoData = await readFileAsBase64(compressPhotoFile);
                    }

                    if (!idkey || !status || !timeCompress) { // เพิ่มเงื่อนไขการตรวจสอบขั้นต่ำ
                        Swal.fire({ icon: 'warning', title: 'คำเตือน', text: 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน' });
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                        return;
                    }

                    // แปลงวันที่เป็นรูปแบบ DD/MM/YYYY HH:mm
                    const formattedTimeCompress = formatDateForSubmit2(timeCompress);

                    try {
                        let bodyParams = `method=completeJob&idkey=${encodeURIComponent(idkey)}&timeCompress=${encodeURIComponent(formattedTimeCompress)}&compressNote=${encodeURIComponent(compressNote)}&status=${encodeURIComponent(status)}`;
                        if (compressPhotoData) {
                            bodyParams += `&compressPhotoData=${encodeURIComponent(compressPhotoData)}`;
                        }

                        const response = await fetch(WEB_APP_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: bodyParams
                        });
                        const result = await response.json();

                        if (result.success) {
                            Swal.fire({ title: 'สำเร็จ', text: result.message, icon: 'success' });
                            closeCompleteJobModal2();
                            fetchData2(currentUserId2); // รีเฟรชข้อมูลหลังจากอัปเดต
                        } else {
                            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                        }
                    } catch (error) {
                        console.error('Error updating data:', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    }
                });

                /**
                 * ฟังก์ชันอ่านไฟล์เป็น base64
                 * @param {File} file 
                 * @returns {Promise<string>} - base64 string
                 */
                function readFileAsBase64(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            // แยกแค่ base64 string
                            const base64 = e.target.result.split(',')[1];
                            resolve(base64);
                        };
                        reader.onerror = function (e) {
                            reject(e);
                        };
                        reader.readAsDataURL(file);
                    });
                }

                /**
                 * ฟังก์ชันสำหรับแปลงวันที่เป็น GMT+7 และฟอร์แมตให้เข้ากับ datetime-local
                 * @returns {string} - วันที่ในรูปแบบ YYYY-MM-DDTHH:mm
                 */
                function getCurrentDateTimeGMT7_2() {
                    const now = new Date();
                    // แปลงเวลาเป็น UTC
                    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                    // แปลงเวลาเป็น GMT+7
                    const gmt7Time = new Date(utc + (7 * 3600000));
                    const year = gmt7Time.getFullYear();
                    const month = String(gmt7Time.getMonth() + 1).padStart(2, '0');
                    const day = String(gmt7Time.getDate()).padStart(2, '0');
                    const hours = String(gmt7Time.getHours()).padStart(2, '0');
                    const minutes = String(gmt7Time.getMinutes()).padStart(2, '0');
                    return `${year}-${month}-${day}T${hours}:${minutes}`;
                }

                /**
                 * ฟังก์ชันแปลงวันที่จาก DD/MM/YYYY HH:mm เป็นวัตถุ Date
                 * @param {string} dateStr - วันที่ในรูปแบบ DD/MM/YYYY HH:mm
                 * @returns {Date|null} - วัตถุ Date หรือ null หากไม่สามารถแปลงได้
                 */
                function parseDateDDMMYYYYHHmm2(dateStr) {
                    if (!dateStr) return null;
                    const parts = dateStr.split(' ');
                    if (parts.length !== 2) return null;
                    const [datePart, timePart] = parts;
                    const [day, month, year] = datePart.split('/').map(Number);
                    const [hours, minutes] = timePart.split(':').map(Number);
                    return new Date(year, month - 1, day, hours, minutes);
                }

                /**
                 * ฟังก์ชันแปลงวันที่เป็นรูปแบบ DD/MM/YYYY HH:mm
                 */
                function formatDateToDDMMYYYYHHmm2(dateStr) {
                    if (!dateStr) return '';
                    // ตรวจสอบว่าเป็น ISO string หรือ DD/MM/YYYY HH:mm
                    let date;
                    if (dateStr.includes('/') && dateStr.includes(':')) {
                        date = parseDateDDMMYYYYHHmm2(dateStr);
                    } else {
                        date = new Date(dateStr);
                    }
                    if (!date || isNaN(date.getTime())) return '';
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${day}/${month}/${year} ${hours}:${minutes}`;
                }

                /**
                 * ฟังก์ชันแปลงวันที่จาก datetime-local เป็น DD/MM/YYYY HH:mm
                 */
                function formatDateForSubmit2(datetimeLocal) {
                    if (!datetimeLocal) return '';
                    const date = new Date(datetimeLocal);
                    if (isNaN(date.getTime())) return '';
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${day}/${month}/${year} ${hours}:${minutes}`;
                }

                /**
                 * ฟังก์ชันแสดงข้อมูลในรูปแบบตารางสำหรับงานที่เสร็จสิ้น
                 */
                function displayCompletedTable2(data) {
                    const tableBody = document.querySelector('#completed-table-2 tbody');
                    tableBody.innerHTML = '';

                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="py-2 px-4 border text-center text-gray-500">ไม่มีงานที่ดำเนินการสำเร็จ</td></tr>';
                        return;
                    }

                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="py-2 px-4 border text-center">${formatDateToDDMMYYYYHHmm2(row.Date)}</td>
                            <td class="py-2 px-4 border text-center">${row.Name}</td>
                            <td class="py-2 px-4 border text-center">${translateStatus2(row.Status)}</td>
                            <td class="flex flex-between text-xs py-2 px-4 border text-center">
                                <button class="bg-purple-700 text-white py-1 px-3 rounded-lg hover:bg-purple-800 transition" onclick="viewDetails2('${row.idkey}')">รายละเอียด</button>
                                <button class="bg-yellow-500 text-white py-1 px-3 rounded-lg hover:bg-yellow-600 transition" onclick="openEditModal2('${row.idkey}')">แจ้งเรื่อง</button>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                }

                /**
                 * ฟังก์ชันแปลสถานะจากภาษาอังกฤษเป็นภาษาไทย
                 */
                function translateStatus2(status) {
                    switch(status.toLowerCase()) {
                        case 'อนุมัติ': return 'อนุมัติ';
                        case 'ยกเลิก': return 'ยกเลิก';
                        case 'ปฏิเสธ': return 'ปฏิเสธ';
                        case 'กำลังดำเนินการ': return 'กำลังดำเนินการ';
                        case 'ดำเนินการสำเร็จ': return 'ดำเนินการสำเร็จ';
                        default: return status;
                    }
                }

                /**
                 * ฟังก์ชันดูรายละเอียดข้อมูล
                 */
                function viewDetails2(idkey) {
                    const row = tableData2.find(row => row.idkey === idkey);
                    if (row) {
                        Swal.fire({
                            title: 'รายละเอียด',
                            html: `
                                <div style="text-align: left;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr><td style="border: 1px solid #ddd; padding: 8px; width: 40%;"><b>PO:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.idkey}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>สถานะ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.status}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>เวลาเริ่มงาน:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${formatDateToDDMMYYYYHHmm2(row.timeInside)}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>หมายเหตุ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.insideNote || ''}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>เวลาดำเนินการ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${formatDateToDDMMYYYYHHmm2(row.timeProcess)}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>หมายเหตุ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.processNote || ''}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>เวลาเสร็จสิ้น:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${formatDateToDDMMYYYYHHmm2(row.timeCompress)}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>หมายเหตุ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.compressNote || ''}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>อัพโหลดรูป:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.compressPhoto ? `<a href="${row.compressPhoto}" target="_blank" class="text-blue-500 underline">ดูรูป</a>` : 'ไม่มี'}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>ชื่อ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Name || ''}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>ชื่อผู้ดูแล:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Responsible || ''}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>ผู้มอบหมาย:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Admin || ''}</td></tr>
                                        <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>บันทึกเวลา:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${formatDateToDDMMYYYYHHmm2(row.timestamp)}</td></tr>
                                    </table>
                                </div>
                            `,
                            confirmButtonText: 'ปิด'
                        });
                    }
                }

                /**
                 * ฟังก์ชันเปิดโมดอลสำหรับแก้ไขข้อมูล
                 */
                function openEditModal2(idkey) {
                    const row = tableData2.find(row => row.idkey === idkey);
                    if (row) {
                        document.getElementById('edit-idkey-2').value = row.idkey;
                        document.getElementById('edit-status-2').value = row.status;
                        document.getElementById('edit-responsible-2').value = row.Responsible;
                        document.getElementById('edit-admin-note-2').value = row.adminNote;
                        document.getElementById('edit-modal-2').classList.remove('hidden');
                    }
                }

                /**
                 * ฟังก์ชันปิดโมดอล
                 */
                function closeModal2() {
                    document.getElementById('edit-modal-2').classList.add('hidden');
                }

                /**
                 * ฟังก์ชันจัดการฟอร์มแก้ไขข้อมูล
                 */
                document.getElementById('edit-form-2').addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const submitButton = this.querySelector("button[type=submit]");
                    const originalText = submitButton.textContent;
                    submitButton.disabled = true;
                    submitButton.textContent = 'กำลังอัพเดท...';

                    const idkey = document.getElementById('edit-idkey-2').value;
                    const status = document.getElementById('edit-status-2').value;
                    const responsible = document.getElementById('edit-responsible-2').value.trim();
                    const adminNote = document.getElementById('edit-admin-note-2').value.trim();

                    if (!idkey || !status || !responsible || !adminNote) { // เพิ่มเงื่อนไขการตรวจสอบขั้นต่ำ
                        Swal.fire({ icon: 'warning', title: 'คำเตือน', text: 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน' });
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                        return;
                    }

                    try {
                        const response = await fetch(WEB_APP_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `method=updateOrder&idkey=${encodeURIComponent(idkey)}&status=${encodeURIComponent(status)}&responsible=${encodeURIComponent(responsible)}&adminNote=${encodeURIComponent(adminNote)}`
                        });
                        const result = await response.json();

                        if (result.success) {
                            Swal.fire({ title: 'สำเร็จ', text: result.message, icon: 'success' });
                            closeEditModal2();
                            fetchData2(currentUserId2); // รีเฟรชข้อมูลหลังจากอัปเดต
                        } else {
                            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                        }
                    } catch (error) {
                        console.error('Error updating data:', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    }
                });

                /**
                 * ฟังก์ชันรับงาน
                 */
                async function takeJob2(idkey) {
                    if (isSubmitting2) {
                        // หากกำลังส่งข้อมูลอยู่แล้ว ไม่ทำอะไร
                        return;
                    }
                    isSubmitting2 = true; // ตั้งค่าว่ากำลังส่งข้อมูลอยู่

                    Swal.fire({
                        title: 'ยืนยันการรับงาน?',
                        text: `คุณต้องการเปลี่ยนสถานะของ Order ID: ${idkey} เป็น "กำลังดำเนินการ" ใช่หรือไม่?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'ใช่, รับงาน',
                        cancelButtonText: 'ยกเลิก'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            // ปิด SweetAlert2 เพื่อแสดงข้อความกำลังอัพเดท
                            Swal.fire({
                                title: 'กำลังอัพเดท...',
                                allowOutsideClick: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });

                            try {
                                const response = await fetch(WEB_APP_URL, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                    body: `method=takeJob&idkey=${encodeURIComponent(idkey)}`
                                });
                                const resultData = await response.json();

                                if (resultData.success) {
                                    Swal.fire({ title: 'สำเร็จ', text: resultData.message, icon: 'success' });
                                    fetchData2(currentUserId2);
                                } else {
                                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: resultData.message });
                                }
                            } catch (error) {
                                console.error('Error updating data:', error);
                                Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                            } finally {
                                isSubmitting2 = false; // รีเซ็ตตัวแปรหลังจากส่งข้อมูลเสร็จสิ้น
                            }
                        } else {
                            isSubmitting2 = false; // รีเซ็ตตัวแปรถ้าผู้ใช้ยกเลิก
                        }
                    });
                }

                /**
                 * ฟังก์ชันกรองข้อมูล
                 */
                function applyFilters2() {
                    const filterStatus = document.getElementById('filter-status-2').value.toLowerCase();
                    const filterName = document.getElementById('filter-name-2').value.toLowerCase();

                    const filteredData = tableData2.filter(row => {
                        const matchesStatus = filterStatus ? row.status.toLowerCase().includes(filterStatus) : true;
                        const matchesName = filterName ? (row.Name || '').toLowerCase().includes(filterName) : true;
                        const matchesUserId = row.useridresponsible === currentUserId2; // กรองตาม userId

                        return matchesStatus && matchesName && matchesUserId;
                    });

                    // เรียงลำดับข้อมูลจากวันที่ล่าสุดไปยังเก่า
                    filteredData.sort((a, b) => {
                        const dateA = parseDateDDMMYYYYHHmm2(a.timestamp);
                        const dateB = parseDateDDMMYYYYHHmm2(b.timestamp);
                        return dateB - dateA; // เรียงจากมากไปน้อย (ล่าสุดก่อน)
                    });

                    // รีเซ็ตหน้าปัจจุบันเมื่อมีการกรองใหม่
                    currentPage2 = 1;
                    totalPages2 = Math.ceil(filteredData.length / rowsPerPage2);

                    displayTasks2(filteredData);
                }
            </script>
        </div>
    </div>

    <!-- JavaScript สำหรับการสลับแท็บ -->
    <script>
        function openTab(evt, tabId) {
            // ซ่อนเนื้อหาของทุกแท็บ
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.add('hidden'));

            // ลบคลาส active จากทุกลิงก์แท็บ
            const tabLinks = document.querySelectorAll('ul li a');
            tabLinks.forEach(link => link.classList.remove('text-blue-500'));

            // แสดงเนื้อหาของแท็บที่เลือก
            document.getElementById(tabId).classList.remove('hidden');

            // เพิ่มคลาส active ให้กับลิงก์แท็บที่เลือก
            evt.currentTarget.classList.add('text-blue-500');
        }

        // เปิดแท็บแรกเมื่อโหลดหน้า
        document.addEventListener('DOMContentLoaded', function() {
            const firstTab = document.querySelector('ul li a');
            if (firstTab) {
                firstTab.click();
            }
        });
    </script>
</body>
</html>
