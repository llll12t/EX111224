<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการข้อมูลการสั่งซื้อ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/liff.js"></script>
</head>

<style>
    .bg-green {
        background: #078274;
    }
    .disabled-button {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

<body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-xl mx-auto">
        <!-- Header Section -->
        <div class="bg-slate-800 text-white rounded-xl p-4 mb-4">
            <h1 class="text-xl">จัดการข้อมูลการสั่งซื้อ</h1>
        </div>

        <!-- Filter Section -->
        <div class="bg-slate-800 rounded-xl p-4 mb-4">
            <div class="flex flex-wrap gap-4">
                <input type="text" id="filter-name" placeholder="ค้นหาตามชื่อ"
                    class="w-full sm:w-auto flex-1 border px-2 py-1 rounded-xl">
                <select id="filter-status" class="w-full sm:w-auto flex-1 border px-2 py-1 rounded-xl">
                    <option value="">สถานะ</option>
                    <option value="approve">อนุมัติ</option>
                    <option value="pending">รอดำเนินการ</option>
                    <option value="rejected">ปฏิเสธ</option>
                    <option value="กำลังดำเนินการ">กำลังดำเนินการ</option>
                </select>
                <!-- แสดง userId เป็น readonly สำหรับการตรวจสอบ -->
                <input type="hidden" id="userId" readonly>
                <button class="bg-blue-500 text-white py-1 px-3 rounded-xl hover:bg-blue-700"
                    onclick="applyFilters()">กรองข้อมูล</button>
                <button class="bg-gray-500 text-white py-1 px-3 rounded-xl hover:bg-gray-700"
                    onclick="clearFilters()">ยกเลิกการกรอง</button>
            </div>
        </div>

        <!-- Data Table -->
        <table id="data-table" class="min-w-full text-xs bg-white rounded-xl">
            <thead>
                <tr class="text-slate-800 text-sm">
                    <th class="py-2 px-4 border">ชื่อ</th>
                    <th class="py-2 px-4 border">วันที่</th> <!-- เพิ่มคอลัมน์วันที่ -->
                    <th class="py-2 px-4 border">สถานที่</th>
                    <th class="py-2 px-4 border">สถานะ</th>
                </tr>
            </thead>
            <tbody class="text-sm"></tbody>
        </table>
        
        <!-- Loading Message -->
        <div id="loading-message" class="text-center text-gray-500 mt-4" style="display: none;">กำลังโหลดข้อมูล...</div>

        <!-- Pagination Controls -->
        <div id="pagination-controls" class="flex justify-center mt-4 space-x-2">
            <button id="prev-page" class="bg-gray-300 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-400" onclick="changePage(currentPage - 1)">ก่อนหน้า</button>
            <div id="page-numbers" class="flex space-x-1">
                <!-- ตัวเลขหน้าจะถูกสร้างที่นี่ -->
            </div>
            <button id="next-page" class="bg-gray-300 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-400" onclick="changePage(currentPage + 1)">ถัดไป</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-full max-w-md">
            <h2 class="text-xl mb-4">แก้ไขข้อมูลสถานะ</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-idkey">
                
                <div class="mb-4">
                    <label for="edit-status" class="block mb-1">สถานะ</label>
                    <select id="edit-status" class="w-full border px-2 py-1 rounded-xl">
                        <option value="approve">อนุมัติ</option>
                        <option value="pending">รอดำเนินการ</option>
                        <option value="rejected">ปฏิเสธ</option>
                        <option value="กำลังดำเนินการ">กำลังดำเนินการ</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="edit-responsible" class="block mb-1">ผู้รับผิดชอบ</label>
                    <input type="text" id="edit-responsible" class="w-full border px-2 py-1 rounded-xl" required>
                </div>

                <div class="mb-4">
                    <label for="edit-admin-note" class="block mb-1">หมายเหตุ Admin</label>
                    <input type="text" id="edit-admin-note" class="w-full border px-2 py-1 rounded-xl" required>
                </div>

                <div class="flex justify-end mt-4">
                    <button type="button" class="bg-red-500 text-white py-1 px-3 rounded-xl hover:bg-red-700 mr-2" onclick="closeModal()">ยกเลิก</button>
                    <button type="submit" class="bg-blue-500 text-white py-1 px-3 rounded-xl hover:bg-blue-700">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxJoSNrT4OAaEdwusbpVN9tid-kVkVWtBfP7XhXfy_fXUcgeYl2HZSndC95SuNDFVRxAg/exec'; // เปลี่ยนเป็น URL ของ Google Apps Script Web App ของคุณ
        const LIFF_ID = '2006504113-0XkPGbvm'; // เปลี่ยนเป็น LIFF ID ของคุณ

        let tableData = []; 
        let filteredData = [];
        let currentUserId = ''; // ตัวแปรเก็บ userId ปัจจุบัน
        let currentPage = 1;
        const rowsPerPage = 10;
        let totalPages = 1;

        /**
         * ฟังก์ชันแปลงวันที่จากรูปแบบ DD/MM/YYYY HH:mm เป็น Date object
         * @param {string} dateStr - วันที่ในรูปแบบ DD/MM/YYYY HH:mm
         * @returns {Date} - Date object ที่แปลงมา
         */
        function parseDate(dateStr) {
            const [datePart, timePart] = dateStr.split(' ');
            const [day, month, year] = datePart.split('/').map(Number);
            const [hours, minutes] = timePart.split(':').map(Number);
            return new Date(year, month - 1, day, hours, minutes);
        }

        /**
         * ฟังก์ชันเริ่มต้น LIFF
         */
        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    getUserProfile();
                } else {
                    liff.login(); // ทำการล็อกอินถ้ายังไม่ได้ล็อกอิน
                }
            } catch (error) {
                console.error('LIFF Initialization failed', error);
                Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถเริ่มต้น LIFF ได้' });
            }
        }

        /**
         * ฟังก์ชันดึงข้อมูลโปรไฟล์ผู้ใช้จาก LIFF
         */
        async function getUserProfile() {
            try {
                const profile = await liff.getProfile();
                const userId = profile.userId;
                currentUserId = userId;
                document.getElementById('userId').value = userId; // แสดง userId ใน input field
                fetchData(userId); // ดึงและกรองข้อมูลตาม userId
            } catch (error) {
                console.error('Error getting profile data:', error);
                Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถดึงข้อมูลโปรไฟล์ผู้ใช้ได้' });
            }
        }

        /**
         * ฟังก์ชันดึงข้อมูลจาก Google Sheets
         * @param {string} userId - userId ของผู้ใช้
         */
        async function fetchData(userId) {
            document.getElementById('loading-message').style.display = 'block';
            try {
                const response = await fetch(`${WEB_APP_URL}?sheet=Data`);
                const result = await response.json();
                if (result.success) {
                    tableData = result.data;
                    // เรียงข้อมูลตามวันที่ล่าสุดก่อนที่จะกรอง โดยใช้ parseDate
                    tableData.sort((a, b) => parseDate(b.Date) - parseDate(a.Date));
                    applyFilters(); // แสดงข้อมูลหลังจากดึงมาเรียบร้อยแล้ว
                } else {
                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถโหลดข้อมูลได้' });
            } finally {
                document.getElementById('loading-message').style.display = 'none';
            }
        }

        /**
         * ฟังก์ชันแสดงข้อมูลในตาราง
         */
        function displayTable(data) {
            const tableBody = document.querySelector('#data-table tbody');
            tableBody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-2 px-4 text-center border">${row.Name}</td>
                    <td class="py-2 px-4 text-center border">${formatDate(row.Date)}</td> <!-- แสดงวันที่ -->
                    <td class="py-2 px-4 text-center border"><a class="text-green-700" href="${row.Maplink}" target="_blank">เปิดแผนที่</a></td>
                    <td class="py-2 px-4 text-center border">${translateStatus(row.Status)}</td>
                `;
                tableBody.appendChild(tr);
                // แถวปุ่ม Action แบบเต็มแถว
                const actionRow = document.createElement('tr');
                actionRow.innerHTML = `
                    <td colspan="4" class="py-2 px-4 border text-center">
                        <div class="flex flex-between">
                            <button class="bg-purple-700 text-white py-2 px-2 mx-1 rounded-lg hover:bg-purple-700 w-full" onclick="viewDetails('${row.IDkey}')">รายละเอียด</button>
                            <button class="bg-yellow-500 text-white py-2 px-2 mx-1 rounded-lg hover:bg-yellow-700 w-full" onclick="openEditModal('${row.IDkey}')">แจ้งเรื่อง</button>
                            <button 
                                class="bg-green-500 text-white py-2 px-3 rounded-lg hover:bg-green-700 w-full ${row.Status === 'กำลังดำเนินการ' ? 'disabled-button' : ''}" 
                                onclick="${row.Status === 'กำลังดำเนินการ' ? '' : `takeJob('${row.IDkey}')`}" 
                                ${row.Status === 'กำลังดำเนินการ' ? 'disabled' : ''}>
                                ยืนยัน
                            </button>
                        </div>
                    </td>
                `;

                tableBody.appendChild(actionRow);
            });
        }

        /**
         * ฟังก์ชันแปลสถานะจากภาษาอังกฤษเป็นภาษาไทย
         */
        function translateStatus(status) {
            switch(status.toLowerCase()) {
                case 'approve': return 'อนุมัติ';
                case 'pending': return 'รอดำเนินการ';
                case 'rejected': return 'ปฏิเสธ';
                case 'กำลังดำเนินการ': return 'กำลังดำเนินการ';
                default: return status;
            }
        }

        /**
         * ฟังก์ชันแปลงวันที่เป็นรูปแบบ DD/MM/YYYY HH:mm
         */
        function formatDate(dateStr) {
            const date = parseDate(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        /**
         * ฟังก์ชันดูรายละเอียดข้อมูล
         */
        function viewDetails(idkey) {
            const row = tableData.find(row => row.IDkey === idkey);
            if (row) {
                Swal.fire({
                    title: 'รายละเอียด',
                    html: `
                        <div style="text-align: left;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="border: 1px solid #ddd; padding: 8px; width: 40%;"><b>ID Key:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.IDkey}</td></tr>
                                <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>ชื่อ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Name}</td></tr>
                                <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>ที่อยู่:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Address}</td></tr>
                                <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>Map Link:</b></td><td style="border: 1px solid #ddd; padding: 8px;"><a href="${row.Maplink}" target="_blank">เปิดแผนที่</a></td></tr>
                                <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>หมายเลข:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Number}</td></tr>
                                <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>วันที่:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${formatDate(row.Date)}</td></tr>
                                <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>รายละเอียด:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Detail}</td></tr>
                                <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>หมายเหตุ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Note}</td></tr>
                                <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>เบอร์ติดต่อ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Contact}</td></tr>
                                <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>การชำระเงิน:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Payment}</td></tr>
                                <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>สถานะ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${translateStatus(row.Status)}</td></tr>
                                <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>ผู้รับผิดชอบ:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Responsible}</td></tr>
                                <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>Admin:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.Admin}</td></tr>
                                <tr><td style="border: 1px solid #ddd; padding: 8px;"><b>หมายเหตุ Admin:</b></td><td style="border: 1px solid #ddd; padding: 8px;">${row.adminNote}</td></tr>
                            </table>
                        </div>
                    `,
                    confirmButtonText: 'ปิด'
                });
            }
        }

        /**
         * ฟังก์ชันเปิดโมดอลสำหรับแก้ไขข้อมูล
         */
        function openEditModal(idkey) {
            const row = tableData.find(row => row.IDkey === idkey);
            if (row) {
                document.getElementById('edit-idkey').value = row.IDkey;
                document.getElementById('edit-status').value = row.Status;
                document.getElementById('edit-responsible').value = row.Responsible;
                document.getElementById('edit-admin-note').value = row.adminNote;
                document.getElementById('edit-modal').classList.remove('hidden');
            }
        }

        /**
         * ฟังก์ชันปิดโมดอล
         */
        function closeModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        /**
         * ฟังก์ชันจัดการฟอร์มแก้ไขข้อมูล
         */
        document.getElementById('edit-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const idkey = document.getElementById('edit-idkey').value;
            const status = document.getElementById('edit-status').value;
            const responsible = document.getElementById('edit-responsible').value.trim();
            const adminNote = document.getElementById('edit-admin-note').value.trim();

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `method=updateOrder&idkey=${encodeURIComponent(idkey)}&status=${encodeURIComponent(status)}&responsible=${encodeURIComponent(responsible)}&adminNote=${encodeURIComponent(adminNote)}`
                });
                const result = await response.json();

                if (result.success) {
                    Swal.fire({ title: 'สำเร็จ', text: result.message, icon: 'success' });
                    closeModal();
                    fetchData(currentUserId); // รีเฟรชข้อมูลหลังจากอัปเดต
                } else {
                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                }
            } catch (error) {
                console.error('Error updating data:', error);
                Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
            }
        });

        /**
         * ฟังก์ชันรับงาน
         */
        async function takeJob(idkey) {
            Swal.fire({
                title: 'ยืนยันการรับงาน?',
                text: `คุณต้องการเปลี่ยนสถานะของ Order ID: ${idkey} เป็น "กำลังดำเนินการ" ใช่หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ใช่, รับงาน',
                cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(WEB_APP_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `method=takeJob&idkey=${encodeURIComponent(idkey)}`
                        });
                        const resultData = await response.json();

                        if (resultData.success) {
                            Swal.fire({ title: 'สำเร็จ', text: resultData.message, icon: 'success' });
                            fetchData(currentUserId);
                        } else {
                            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: resultData.message });
                        }
                    } catch (error) {
                        console.error('Error updating data:', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                    }
                }
            });
        }

        /**
         * ฟังก์ชันกรองข้อมูล
         */
        function applyFilters() {
            const filterName = document.getElementById('filter-name').value.toLowerCase();
            const filterStatus = document.getElementById('filter-status').value.toLowerCase();

            // Filter by name, status, and userId
            filteredData = tableData.filter(row => {
                const matchesName = row.Name.toLowerCase().includes(filterName);
                const matchesStatus = filterStatus ? row.Status.toLowerCase() === filterStatus : true;
                const matchesUserId = row.UserIDresponsible === currentUserId; // เงื่อนไขกรองตาม userId
                return matchesName && matchesStatus && matchesUserId;
            });

            // เรียงข้อมูลตามวันที่ล่าสุดหลังจากกรอง โดยใช้ parseDate
            filteredData.sort((a, b) => parseDate(b.Date) - parseDate(a.Date));

            // คำนวณจำนวนหน้าทั้งหมด
            totalPages = Math.ceil(filteredData.length / rowsPerPage);
            currentPage = 1;
            setupPagination();

            // แสดงข้อมูลหน้าปัจจุบัน
            const paginatedData = paginateData(filteredData, currentPage);
            displayTable(paginatedData);
        }

        /**
         * ฟังก์ชันยกเลิกการกรอง
         */
        function clearFilters() {
            document.getElementById('filter-name').value = '';
            document.getElementById('filter-status').value = '';
            applyFilters(); // กรองข้อมูลใหม่โดยใช้ userId ปัจจุบัน
        }

        /**
         * ฟังก์ชันตั้งค่าการแบ่งหน้า
         */
        function setupPagination() {
            const pageNumbersContainer = document.getElementById('page-numbers');
            pageNumbersContainer.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.innerText = i;
                pageButton.className = `px-3 py-1 rounded-lg ${i === currentPage ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`;
                pageButton.onclick = () => changePage(i);
                pageNumbersContainer.appendChild(pageButton);
            }

            // ปรับสถานะปุ่มก่อนหน้าและถัดไป
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
        }

        /**
         * ฟังก์ชันเปลี่ยนหน้า
         * @param {number} page - หน้าที่ต้องการเปลี่ยนไป
         */
        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            setupPagination();

            // แสดงข้อมูลหน้าปัจจุบัน
            const paginatedData = paginateData(filteredData, currentPage);
            displayTable(paginatedData);
        }

        /**
         * ฟังก์ชันแบ่งข้อมูลตามหน้า
         * @param {Array} data - ข้อมูลทั้งหมด
         * @param {number} page - หน้าปัจจุบัน
         * @returns {Array} - ข้อมูลที่อยู่ในหน้าปัจจุบัน
         */
        function paginateData(data, page) {
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            return data.slice(start, end);
        }

        /**
         * ฟังก์ชันเริ่มต้นเมื่อโหลดหน้า
         */
        window.onload = function() {
            initializeLiff(); // เริ่มต้น LIFF
            // fetchData() ถูกเรียกภายใน getUserProfile() หลังจากได้ userId แล้ว
        };
    </script>
</body>
</html>
