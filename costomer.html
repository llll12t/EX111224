<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ผูก LINE กับเบอร์โทร</title>
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
    <h2 class="text-2xl font-bold mb-6 text-center">ผูก LINE กับเบอร์โทร</h2>
    <div class="mb-4">
      <label for="contact" class="block text-gray-700 font-semibold mb-2">เบอร์ติดต่อ</label>
      <input type="text" id="contact" placeholder="กรุณากรอกเบอร์ติดต่อ" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400">
    </div>
    <button onclick="bindUser()" class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition duration-200">ผูกข้อมูล</button>
  </div>

  <script>
    // แทนที่ "YOUR_LIFF_ID" ด้วย LIFF ID ของคุณ
    const LIFF_ID = "2006504113-w9Y247mX";

    async function initializeApp() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
        }
      } catch (error) {
        console.error('Error initializing LIFF:', error);
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาด',
          text: 'ไม่สามารถเชื่อมต่อกับ LIFF ได้',
        });
      }
    }

    async function bindUser() {
      const contact = document.getElementById('contact').value.trim();

      // ตรวจสอบว่ากรอกเบอร์โทรหรือไม่
      if (contact === "") {
        Swal.fire({
          icon: 'warning',
          title: 'เตือน!',
          text: 'กรุณากรอกเบอร์โทรก่อน',
        });
        return;
      }

      // ตรวจสอบรูปแบบเบอร์โทร (ตัวอย่าง: 10 หลัก)
      const phoneRegex = /^[0-9]{10}$/;
      if (!phoneRegex.test(contact)) {
        Swal.fire({
          icon: 'error',
          title: 'เบอร์โทรไม่ถูกต้อง',
          text: 'กรุณากรอกเบอร์โทรที่ถูกต้อง (10 หลัก)',
        });
        return;
      }

      try {
        const profile = await liff.getProfile();
        const userId = profile.userId;

        // แสดง Loading ขณะส่งข้อมูล
        Swal.fire({
          title: 'กำลังผูกข้อมูล',
          text: 'กรุณารอสักครู่...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        // ส่งข้อมูลไปยัง Google Apps Script
        const response = await fetch('https://script.google.com/macros/s/AKfycbz6vfjKlYhvVk4QGJf0pyl7S5P2ytSzwpBo8IqrDvBTP3QGH31uwbY-8gr9TTcNRRYt/exec', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'bindUserData',
            userId: userId,
            contact: contact
          })
        });

        const result = await response.json();

        Swal.close(); // ปิด Loading

        if (result.status === 'success') {
          Swal.fire({
            icon: 'success',
            title: 'สำเร็จ',
            text: result.message,
          }).then(() => {
            // เคลียร์ฟอร์มหลังจากสำเร็จ
            document.getElementById('contact').value = '';
          });
        } else {
          Swal.fire({
            icon: 'info',
            title: 'ข้อมูล',
            text: result.message,
          });
        }
      } catch (error) {
        console.error('Error:', error);
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาด',
          text: 'ไม่สามารถส่งข้อมูลได้',
        });
      }
    }

    // เรียกใช้งานฟังก์ชัน initializeApp เมื่อโหลดหน้าเว็บ
    window.onload = initializeApp;
  </script>
</body>
</html>
