<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/liff.js"></script>
  <style>
    .bg-green-custom { background: #FFFFFF; }
    .disabled-button { opacity: 0.5; cursor: not-allowed; }
    .bg-green { background: #078274; }
    .border-green { border: 2px solid #078274; border-radius: 10px; }
    .bg-inactive-tab { background: transparent; }
    .active-tab { background-color: #1A2A40; border-color: #1A2A40; color: #FFFFFF; }
    .inactive-tab { background-color: #B1FF45; border-color: transparent; color: #1A2A40; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-md mx-auto">
    <div id="tab-operation-content">
      <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô -->
      <div class="w-full max-w-md mb-4">
        <div class="bg-green-custom rounded-lg p-4 mb-4">
          <div class="flex flex-wrap gap-4">
            <select id="operation-filter-status" onchange="operationApplyFilters()"
              class="w-full sm:w-auto flex-1 border p-2 rounded-lg">
              <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
              <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</option>
              <option value="‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢">‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢</option>
              <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</option>
              <option value="‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
              <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
              <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
              <option value="‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
            </select>
            <input type="text" id="operation-filter-name" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠"
              class="w-full sm:w-auto flex-1 border p-2 rounded-lg" oninput="operationApplyFilters()">
            <input type="hidden" id="operation-userId" placeholder="userId" readonly
              class="w-full sm:w-auto flex-1 border p-2 rounded-lg bg-gray-100">
          </div>
        </div>
      </div>

      <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô -->
      <div id="operation-task-list" class="bg-white w-full max-w-md p-2"></div>
      <div id="operation-completed-tasks" class="bg-white w-full max-w-md p-2 mt-4"></div>
      <div id="operation-loading-message" class="text-center text-gray-500 mt-4" style="display: none;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

      <!-- Modal ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô -->
      <div id="operation-view-details-modal"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg w-full max-w-lg overflow-y-auto max-h-full">
          <h2 class="text-xl mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
          <div id="operation-details-content" class="space-y-2"></div>
          <div class="flex justify-end mt-4 space-x-2">
            <button type="button" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-700"
              onclick="operationCloseViewDetailsModal()">‡∏õ‡∏¥‡∏î</button>
          </div>
        </div>
      </div>

      <!-- Modal ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á -->
      <div id="operation-start-job-modal"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg w-full max-w-md overflow-y-auto max-h-full">
          <h2 class="text-xl mb-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h2>
          <form id="operation-start-job-form">
            <input type="hidden" id="operation-start-job-idkey">
            <div class="mb-4">
              <label for="operation-start-status" class="block mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <select id="operation-start-status" class="w-full border p-2 rounded-lg" required>
                <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" selected>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="operation-start-time-inside" class="block mb-1">‡πÄ‡∏ß‡∏•‡∏≤</label>
              <input type="datetime-local" id="operation-start-time-inside" class="w-full border p-2 rounded-lg" required>
            </div>
            <div class="mb-4">
              <label for="operation-start-inside-note" class="block mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <textarea id="operation-start-inside-note" class="w-full border p-2 rounded-lg"></textarea>
            </div>
            <div class="flex justify-end mt-4 space-x-2">
              <button type="button" class="bg-red-500 text-white p-3 w-1/3 rounded-lg hover:bg-red-700"
                onclick="operationCloseStartJobModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="bg-blue-500 text-white p-3 w-2/3 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal ‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢ -->
      <div id="operation-process-job-modal"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg w-full max-w-md overflow-y-auto max-h-full">
          <h2 class="text-xl mb-4">‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢</h2>
          <form id="operation-process-job-form">
            <input type="hidden" id="operation-process-job-idkey">
            <div class="mb-4">
              <label for="operation-process-status" class="block mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <select id="operation-process-status" class="w-full border p-2 rounded-lg" required>
                <option value="‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢" selected>‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="operation-process-time-process" class="block mb-1">‡πÄ‡∏ß‡∏•‡∏≤</label>
              <input type="datetime-local" id="operation-process-time-process" class="w-full border p-2 rounded-lg" required>
            </div>
            <div class="mb-4">
              <label for="operation-process-process-note" class="block mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <textarea id="operation-process-process-note" class="w-full border p-2 rounded-lg"></textarea>
            </div>
            <div class="flex justify-end mt-4 space-x-2">
              <button type="button" class="bg-red-500 text-white p-3 w-1/3 rounded-lg hover:bg-red-700"
                onclick="operationCloseProcessJobModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="bg-blue-500 text-white p-3 w-2/3 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) -->
      <div id="operation-start-work-modal"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg w-full max-w-md overflow-y-auto max-h-full">
          <h2 class="text-xl mb-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</h2>
          <form id="operation-start-work-form">
            <input type="hidden" id="operation-start-work-idkey">
            <div class="mb-4">
              <label for="operation-start-work-status" class="block mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <select id="operation-start-work-status" class="w-full border p-2 rounded-lg" required>
                <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô" selected>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="operation-start-work-time" class="block mb-1">‡πÄ‡∏ß‡∏•‡∏≤</label>
              <input type="datetime-local" id="operation-start-work-time" class="w-full border p-2 rounded-lg" required>
            </div>
            <div class="mb-4">
              <label for="operation-start-work-note" class="block mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <textarea id="operation-start-work-note" class="w-full border p-2 rounded-lg"></textarea>
            </div>
            <div class="flex justify-end mt-4 space-x-2">
              <button type="button" class="bg-red-500 text-white p-3 w-1/3 rounded-lg hover:bg-red-700"
                onclick="operationCloseStartWorkModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="bg-blue-500 text-white p-3 w-2/3 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô -->
      <div id="operation-complete-job-modal"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg w-full max-w-lg overflow-y-auto max-h-full">
          <h2 class="text-xl mb-4">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</h2>
          <form id="operation-complete-job-form" enctype="multipart/form-data">
            <input type="hidden" id="operation-complete-job-idkey">
            <div class="mb-4">
              <label for="operation-complete-status" class="block mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <input type="text" id="operation-complete-status" value="‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">
            </div>
            <div class="mb-4">
              <label for="operation-complete-time-compress" class="block mb-1">‡πÄ‡∏ß‡∏•‡∏≤</label>
              <input type="datetime-local" id="operation-complete-time-compress" class="w-full border p-2 rounded-lg" required>
            </div>
            <div class="mb-4">
              <label for="operation-complete-compress-note" class="block mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <textarea id="operation-complete-compress-note" class="w-full border p-2 rounded-lg"></textarea>
            </div>
            <div class="mb-4">
              <label for="operation-complete-compress-photo" class="block mb-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
              <input type="file" id="operation-complete-compress-photo" accept="image/*" class="w-full border p-2 rounded-lg">
            </div>
            <div class="flex justify-end mt-4 space-x-2">
              <button type="button" class="bg-red-500 text-white p-3 w-1/3 rounded-lg hover:bg-red-700"
                onclick="operationCloseCompleteJobModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="bg-blue-500 text-white p-3 w-2/3 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* -------------------- HTML Scripts (Operation Management) -------------------- */
    (function() {
      const WEB_APP_URL_OPERATION = 'https://script.google.com/macros/s/your_script_id/exec'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Web App
      const LIFF_ID_OPERATION = 'your_liff_id'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      let operationCurrentUserId = '';
      let operationTableData = [];
      let currentPagePendingOperation = 1;
      let currentPageCompletedOperation = 1;
      const operationItemsPerPage = 10;

      async function operationInitializeLiff() {
        try {
          await liff.init({ liffId: LIFF_ID_OPERATION });
          if (liff.isLoggedIn()) {
            operationGetUserProfile();
          } else {
            liff.login();
          }
        } catch (error) {
          console.error('LIFF Initialization failed', error);
        }
      }

      async function operationGetUserProfile() {
        try {
          const profile = await liff.getProfile();
          const userId = profile.userId;
          operationCurrentUserId = userId;
          document.getElementById('operation-userId').value = userId;
          operationFetchData(userId);
        } catch (error) {
          console.error('Error getting profile data:', error);
        }
      }

      async function operationFetchData(userId) {
        document.getElementById('operation-loading-message').style.display = 'block';
        try {
          const response = await fetch(`${WEB_APP_URL_OPERATION}?sheet=Dataservice`);
          const result = await response.json();
          if (result.success) {
            operationTableData = result.data;
            operationApplyFilters(userId);
          } else {
            Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: result.message });
          }
        } catch (error) {
          console.error('Error fetching data:', error);
          Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ' });
        } finally {
          document.getElementById('operation-loading-message').style.display = 'none';
        }
      }

      function operationApplyFilters(userId = operationCurrentUserId) {
        const filterStatus = document.getElementById('operation-filter-status').value.toLowerCase();
        const filterName = document.getElementById('operation-filter-name').value.toLowerCase();

        const filteredData = operationTableData.filter(row => {
          const matchesStatus = filterStatus ? row.status.toLowerCase().includes(filterStatus) : true;
          const matchesName = filterName ? (row.Name || '').toLowerCase().includes(filterName) : true;
          const matchesUserId = row.useridresponsible === userId;
          return matchesStatus && matchesName && matchesUserId;
        });

        filteredData.sort((a, b) => {
          const dateA = operationParseDateDDMMYYYYHHmm(a.timestamp);
          const dateB = operationParseDateDDMMYYYYHHmm(b.timestamp);
          return dateB - dateA;
        });

        currentPagePendingOperation = 1;
        currentPageCompletedOperation = 1;
        operationDisplayTasks(filteredData);
      }

      function operationDisplayTasks(data) {
        const taskList = document.getElementById('operation-task-list');
        const completedTasks = document.getElementById('operation-completed-tasks');
        taskList.innerHTML = '';
        completedTasks.innerHTML = '';

        const pendingTasks = data.filter(row => row.status !== '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
        const completedTaskData = data.filter(row => row.status === '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');

        const totalPagesPending = Math.ceil(pendingTasks.length / operationItemsPerPage);
        if (currentPagePendingOperation > totalPagesPending) currentPagePendingOperation = totalPagesPending || 1;
        const totalPagesCompleted = Math.ceil(completedTaskData.length / operationItemsPerPage);
        if (currentPageCompletedOperation > totalPagesCompleted) currentPageCompletedOperation = totalPagesCompleted || 1;

        const taskListHeading = document.createElement('h3');
        taskListHeading.className = 'text-lg font-semibold mb-2';
        taskListHeading.textContent = '‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥';
        taskList.appendChild(taskListHeading);

        const startPending = (currentPagePendingOperation - 1) * operationItemsPerPage;
        const endPending = startPending + operationItemsPerPage;
        const tasksToDisplay = pendingTasks.slice(startPending, endPending);

        tasksToDisplay.forEach(row => {
          const card = document.createElement('div');
          card.className = 'border-green rounded-lg p-4 mb-4';

          const header = document.createElement('div');
          header.className = 'grid grid-cols-3 gap-4 border-b pb-2';

          const statusContainer = document.createElement('div');
          statusContainer.className = 'flex flex-col items-start';
          const statusLabel = document.createElement('span');
          statusLabel.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
          statusLabel.className = 'text-sm text-gray-600 mb-1';
          const statusSpan = document.createElement('span');
          statusSpan.textContent = row.status;
          statusSpan.className = 'font-normal text-base';
          statusContainer.appendChild(statusLabel);
          statusContainer.appendChild(statusSpan);

          const nameContainer = document.createElement('div');
          nameContainer.className = 'flex flex-col items-start';
          const nameLabel = document.createElement('span');
          nameLabel.textContent = '‡∏ä‡∏∑‡πà‡∏≠';
          nameLabel.className = 'text-sm text-gray-600 mb-1';
          const nameSpan = document.createElement('span');
          nameSpan.textContent = row.Name || '';
          nameSpan.className = 'font-normal text-base';
          nameContainer.appendChild(nameLabel);
          nameContainer.appendChild(nameSpan);

          const detailsContainer = document.createElement('div');
          detailsContainer.className = 'flex flex-col items-start';
          const detailsLabel = document.createElement('span');
          detailsLabel.textContent = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
          detailsLabel.className = 'text-sm text-gray-600 mb-1';
          const detailsButton = document.createElement('button');
          detailsButton.className = 'text-blue-500 underline';
          detailsButton.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
          detailsButton.onclick = () => operationOpenViewDetailsModal(row.idkey);
          detailsContainer.appendChild(detailsLabel);
          detailsContainer.appendChild(detailsButton);

          header.appendChild(statusContainer);
          header.appendChild(nameContainer);
          header.appendChild(detailsContainer);

          const actionButtons = document.createElement('div');
          actionButtons.className = 'grid grid-cols-4 gap-4 mt-2 text-sm';

          const startButton = document.createElement('button');
          startButton.className = 'bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition';
          startButton.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á';
          startButton.onclick = () => operationOpenStartJobModal(row.idkey);

          const processButton = document.createElement('button');
          processButton.className = 'bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition';
          processButton.textContent = '‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô';
          processButton.onclick = () => operationOpenProcessJobModal(row.idkey);

          const startWorkButton = document.createElement('button');
          startWorkButton.className = 'bg-purple-500 text-white py-2 px-4 rounded-lg hover:bg-purple-600 transition';
          startWorkButton.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô';
          startWorkButton.onclick = () => operationOpenStartWorkModal(row.idkey);

          const completeButton = document.createElement('button');
          completeButton.className = 'bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition';
          completeButton.textContent = '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
          completeButton.onclick = () => operationOpenCompleteJobModal(row.idkey);

          // ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ disable ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
          switch(row.status) {
            case '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£':
              processButton.disabled = true;
              completeButton.disabled = true;
              processButton.classList.add('disabled-button');
              completeButton.classList.add('disabled-button');
              break;
            case '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á':
              startButton.disabled = true;
              completeButton.disabled = true;
              startButton.classList.add('disabled-button');
              completeButton.classList.add('disabled-button');
              break;
            case '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢':
              startButton.disabled = true;
              processButton.disabled = true;
              startButton.classList.add('disabled-button');
              processButton.classList.add('disabled-button');
              break;
            case '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô':
              // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô" ‡πÉ‡∏´‡πâ disable ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
              startWorkButton.disabled = true;
              startWorkButton.classList.add('disabled-button');
              break;
            case '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô':
              startButton.disabled = true;
              processButton.disabled = true;
              completeButton.disabled = true;
              startButton.classList.add('disabled-button');
              processButton.classList.add('disabled-button');
              completeButton.classList.add('disabled-button');
              break;
            default:
              break;
          }

          actionButtons.appendChild(startButton);
          actionButtons.appendChild(processButton);
          actionButtons.appendChild(startWorkButton);
          actionButtons.appendChild(completeButton);

          card.appendChild(header);
          card.appendChild(actionButtons);
          taskList.appendChild(card);
        });

        if (totalPagesPending > 1) {
          const paginationDiv = operationDisplayPagination(totalPagesPending, currentPagePendingOperation, 'pending');
          taskList.appendChild(paginationDiv);
        }

        const completedTasksHeading = document.createElement('h3');
        completedTasksHeading.className = 'text-lg font-semibold mb-2 mt-4';
        completedTasksHeading.textContent = '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô/‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        completedTasks.appendChild(completedTasksHeading);

        const completedHeader = document.createElement('div');
        completedHeader.className = 'flex justify-between font-bold mb-2';
        completedHeader.innerHTML = `<span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span><span>‡∏ä‡∏∑‡πà‡∏≠</span><span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>`;
        completedTasks.appendChild(completedHeader);

        const startCompleted = (currentPageCompletedOperation - 1) * operationItemsPerPage;
        const endCompleted = startCompleted + operationItemsPerPage;
        const completedToDisplay = completedTaskData.slice(startCompleted, endCompleted);

        completedToDisplay.forEach(row => {
          const taskItem = document.createElement('div');
          taskItem.className = 'flex justify-between py-2';
          const statusSpan = document.createElement('span');
          statusSpan.textContent = row.status;
          const nameSpan = document.createElement('span');
          nameSpan.textContent = row.Name || '';
          const detailsButton = document.createElement('button');
          detailsButton.className = 'text-blue-500';
          detailsButton.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
          detailsButton.onclick = () => operationOpenViewDetailsModal(row.idkey);
          taskItem.appendChild(statusSpan);
          taskItem.appendChild(nameSpan);
          taskItem.appendChild(detailsButton);
          completedTasks.appendChild(taskItem);
        });

        if (totalPagesCompleted > 1) {
          const paginationDiv = operationDisplayPagination(totalPagesCompleted, currentPageCompletedOperation, 'completed');
          completedTasks.appendChild(paginationDiv);
        }
      }

      window.operationOpenViewDetailsModal = function(idkey) {
        const row = operationTableData.find(row => row.idkey === idkey);
        if (row) {
          const detailsContent = document.getElementById('operation-details-content');
          detailsContent.innerHTML = `
            <p><strong>PO:</strong> ${row.idkey}</p>
            <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${row.status}</p>
            <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á):</strong> ${operationFormatDateToDDMMYYYYHHmm(row.timeInside)}</p>
            <p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${row.insideNote || ''}</p>
            <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢:</strong> ${operationFormatDateToDDMMYYYYHHmm(row.timeProcess)}</p>
            <p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${row.processNote || ''}</p>
            <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô):</strong> ${operationFormatDateToDDMMYYYYHHmm(row["time-start"])}</p>
            <p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${row["start-note"] || ''}</p>
            <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô:</strong> ${operationFormatDateToDDMMYYYYHHmm(row.timeCompress)}</p>
            <p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${row.compressNote || ''}</p>
            <p><strong>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ:</strong> ${row.compressPhoto ? `<a href="${row.compressPhoto}" target="_blank" class="text-blue-500 underline">‡∏î‡∏π‡∏£‡∏π‡∏õ</a>` : '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</p>
            <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${row.Name || ''}</p>
            <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•:</strong> ${row.Responsible || ''}</p>
            <p><strong>‡∏ú‡∏π‡πâ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢:</strong> ${row.Admin || ''}</p>
            <p><strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${operationFormatDateToDDMMYYYYHHmm(row.timestamp)}</p>
          `;
          document.getElementById('operation-view-details-modal').classList.remove('hidden');
        }
      }

      window.operationCloseViewDetailsModal = function() {
        document.getElementById('operation-view-details-modal').classList.add('hidden');
      }

      // Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á"
      window.operationOpenStartJobModal = function(idkey) {
        const row = operationTableData.find(row => row.idkey === idkey);
        if (row) {
          document.getElementById('operation-start-job-idkey').value = row.idkey;
          document.getElementById('operation-start-time-inside').value = operationGetCurrentDateTimeGMT7();
          document.getElementById('operation-start-inside-note').value = row.insideNote || '';
          document.getElementById('operation-start-status').value = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á';
          document.getElementById('operation-start-job-modal').classList.remove('hidden');
        }
      }
      window.operationCloseStartJobModal = function() {
        document.getElementById('operation-start-job-modal').classList.add('hidden');
      }

      document.getElementById('operation-start-job-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const submitButton = this.querySelector("button[type=submit]");
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó...';
        const idkey = document.getElementById('operation-start-job-idkey').value;
        const status = document.getElementById('operation-start-status').value;
        const timeInside = document.getElementById('operation-start-time-inside').value;
        const insideNote = document.getElementById('operation-start-inside-note').value.trim();
        if (!idkey || !status || !timeInside) {
          Swal.fire({ icon: 'warning', title: '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' });
          submitButton.disabled = false;
          submitButton.textContent = originalText;
          return;
        }
        const formattedTimeInside = operationFormatDateForSubmit(timeInside);
        try {
          const response = await fetch(WEB_APP_URL_OPERATION, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `method=startJob&idkey=${encodeURIComponent(idkey)}&timeInside=${encodeURIComponent(formattedTimeInside)}&insideNote=${encodeURIComponent(insideNote)}&status=${encodeURIComponent(status)}`
          });
          const result = await response.json();
          if (result.success) {
            Swal.fire({ title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: result.message, icon: 'success' });
            operationCloseStartJobModal();
            operationFetchData(operationCurrentUserId);
          } else {
            Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: result.message });
          }
        } catch (error) {
          console.error('Error updating data:', error);
          Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ' });
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      });

      // Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢"
      window.operationOpenProcessJobModal = function(idkey) {
        const row = operationTableData.find(row => row.idkey === idkey);
        if (row) {
          document.getElementById('operation-process-job-idkey').value = row.idkey;
          document.getElementById('operation-process-time-process').value = operationGetCurrentDateTimeGMT7();
          document.getElementById('operation-process-process-note').value = row.processNote || '';
          document.getElementById('operation-process-status').value = '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢';
          document.getElementById('operation-process-job-modal').classList.remove('hidden');
        }
      }
      window.operationCloseProcessJobModal = function() {
        document.getElementById('operation-process-job-modal').classList.add('hidden');
      }

      document.getElementById('operation-process-job-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const submitButton = this.querySelector("button[type=submit]");
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó...';
        const idkey = document.getElementById('operation-process-job-idkey').value;
        const status = document.getElementById('operation-process-status').value;
        const timeProcess = document.getElementById('operation-process-time-process').value;
        const processNote = document.getElementById('operation-process-process-note').value.trim();
        if (!idkey || !status || !timeProcess) {
          Swal.fire({ icon: 'warning', title: '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' });
          submitButton.disabled = false;
          submitButton.textContent = originalText;
          return;
        }
        const formattedTimeProcess = operationFormatDateForSubmit(timeProcess);
        try {
          const response = await fetch(WEB_APP_URL_OPERATION, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `method=processJob&idkey=${encodeURIComponent(idkey)}&timeProcess=${encodeURIComponent(formattedTimeProcess)}&processNote=${encodeURIComponent(processNote)}&status=${encodeURIComponent(status)}`
          });
          const result = await response.json();
          if (result.success) {
            Swal.fire({ title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: result.message, icon: 'success' });
            operationCloseProcessJobModal();
            operationFetchData(operationCurrentUserId);
          } else {
            Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: result.message });
          }
        } catch (error) {
          console.error('Error updating data:', error);
          Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ' });
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      });

      // Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô" (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà)
      window.operationOpenStartWorkModal = function(idkey) {
        const row = operationTableData.find(row => row.idkey === idkey);
        if (row) {
          document.getElementById('operation-start-work-idkey').value = row.idkey;
          document.getElementById('operation-start-work-time').value = operationGetCurrentDateTimeGMT7();
          document.getElementById('operation-start-work-note').value = row["start-note"] || '';
          document.getElementById('operation-start-work-status').value = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô';
          document.getElementById('operation-start-work-modal').classList.remove('hidden');
        }
      }
      window.operationCloseStartWorkModal = function() {
        document.getElementById('operation-start-work-modal').classList.add('hidden');
      }

      document.getElementById('operation-start-work-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const submitButton = this.querySelector("button[type=submit]");
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó...';
        const idkey = document.getElementById('operation-start-work-idkey').value;
        const status = document.getElementById('operation-start-work-status').value;
        const timeStart = document.getElementById('operation-start-work-time').value;
        const startNote = document.getElementById('operation-start-work-note').value.trim();
        if (!idkey || !status || !timeStart) {
          Swal.fire({ icon: 'warning', title: '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' });
          submitButton.disabled = false;
          submitButton.textContent = originalText;
          return;
        }
        const formattedTimeStart = operationFormatDateForSubmit(timeStart);
        try {
          const response = await fetch(WEB_APP_URL_OPERATION, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `method=startJobAction&idkey=${encodeURIComponent(idkey)}&timeStart=${encodeURIComponent(formattedTimeStart)}&startNote=${encodeURIComponent(startNote)}&status=${encodeURIComponent(status)}`
          });
          const result = await response.json();
          if (result.success) {
            Swal.fire({ title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: result.message, icon: 'success' });
            operationCloseStartWorkModal();
            operationFetchData(operationCurrentUserId);
          } else {
            Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: result.message });
          }
        } catch (error) {
          console.error('Error updating data:', error);
          Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ' });
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      });

      // Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"
      window.operationOpenCompleteJobModal = function(idkey) {
        const row = operationTableData.find(row => row.idkey === idkey);
        if (row) {
          document.getElementById('operation-complete-job-idkey').value = row.idkey;
          document.getElementById('operation-complete-time-compress').value = operationGetCurrentDateTimeGMT7();
          document.getElementById('operation-complete-compress-note').value = row.compressNote || '';
          document.getElementById('operation-complete-compress-photo').value = '';
          document.getElementById('operation-complete-status').value = '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
          document.getElementById('operation-complete-job-modal').classList.remove('hidden');
        }
      }
      window.operationCloseCompleteJobModal = function() {
        document.getElementById('operation-complete-job-modal').classList.add('hidden');
      }

      document.getElementById('operation-complete-job-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const submitButton = this.querySelector("button[type=submit]");
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó...';
        const idkey = document.getElementById('operation-complete-job-idkey').value;
        const status = document.getElementById('operation-complete-status').value;
        const timeCompress = document.getElementById('operation-complete-time-compress').value;
        const compressNote = document.getElementById('operation-complete-compress-note').value.trim();
        const compressPhotoInput = document.getElementById('operation-complete-compress-photo');
        const compressPhotoFile = compressPhotoInput.files[0];
        let compressPhotoData = '';
        if (compressPhotoFile) {
          compressPhotoData = await operationReadFileAsBase64(compressPhotoFile);
        }
        if (!idkey || !status || !timeCompress) {
          Swal.fire({ icon: 'warning', title: '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' });
          submitButton.disabled = false;
          submitButton.textContent = originalText;
          return;
        }
        const formattedTimeCompress = operationFormatDateForSubmit(timeCompress);
        try {
          let bodyParams = `method=completeJob&idkey=${encodeURIComponent(idkey)}&timeCompress=${encodeURIComponent(formattedTimeCompress)}&compressNote=${encodeURIComponent(compressNote)}&status=${encodeURIComponent(status)}`;
          if (compressPhotoData) {
            bodyParams += `&compressPhotoData=${encodeURIComponent(compressPhotoData)}`;
          }
          const response = await fetch(WEB_APP_URL_OPERATION, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: bodyParams
          });
          const result = await response.json();
          if (result.success) {
            Swal.fire({ title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: result.message, icon: 'success' });
            operationCloseCompleteJobModal();
            operationFetchData(operationCurrentUserId);
          } else {
            Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: result.message });
          }
        } catch (error) {
          console.error('Error updating data:', error);
          Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ' });
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      });

      function operationReadFileAsBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const base64 = e.target.result.split(',')[1];
            resolve(base64);
          };
          reader.onerror = function(e) {
            reject(e);
          };
          reader.readAsDataURL(file);
        });
      }

      function operationGetCurrentDateTimeGMT7() {
        const now = new Date();
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        const gmt7Time = new Date(utc + (7 * 3600000));
        const year = gmt7Time.getFullYear();
        const month = String(gmt7Time.getMonth() + 1).padStart(2, '0');
        const day = String(gmt7Time.getDate()).padStart(2, '0');
        const hours = String(gmt7Time.getHours()).padStart(2, '0');
        const minutes = String(gmt7Time.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      }

      function operationFormatDateToDDMMYYYYHHmm(dateStr) {
        if (!dateStr) return '';
        let date;
        if (dateStr.includes('/') && dateStr.includes(':')) {
          date = operationParseDateDDMMYYYYHHmm(dateStr);
        } else {
          date = new Date(dateStr);
        }
        if (!date || isNaN(date.getTime())) return '';
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}/${month}/${year} ${hours}:${minutes}`;
      }

      function operationParseDateDDMMYYYYHHmm(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split(' ');
        if (parts.length !== 2) return null;
        const [datePart, timePart] = parts;
        const [day, month, year] = datePart.split('/').map(Number);
        const [hours, minutes] = timePart.split(':').map(Number);
        return new Date(year, month - 1, day, hours, minutes);
      }

      function operationFormatDateForSubmit(datetimeLocal) {
        if (!datetimeLocal) return '';
        const date = new Date(datetimeLocal);
        if (isNaN(date.getTime())) return '';
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}/${month}/${year} ${hours}:${minutes}`;
      }

      function operationDisplayPagination(pages, currentPage, type) {
        const paginationDiv = document.createElement('div');
        paginationDiv.className = 'flex justify-center mt-4 space-x-2';
        const prevButton = document.createElement('button');
        prevButton.className = 'bg-gray-500 text-white py-1 px-3 rounded-lg';
        prevButton.textContent = '‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤';
        prevButton.disabled = currentPage === 1;
        prevButton.onclick = () => {
          if (type === 'pending') { currentPagePendingOperation--; } else { currentPageCompletedOperation--; }
          operationApplyFilters();
        };
        const nextButton = document.createElement('button');
        nextButton.className = 'bg-gray-500 text-white py-1 px-3 rounded-lg';
        nextButton.textContent = '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
        nextButton.disabled = currentPage === pages;
        nextButton.onclick = () => {
          if (type === 'pending') { currentPagePendingOperation++; } else { currentPageCompletedOperation++; }
          operationApplyFilters();
        };
        paginationDiv.appendChild(prevButton);
        paginationDiv.appendChild(nextButton);
        return paginationDiv;
      }

      function createTimelineSteps(params) {
        const steps = [];
        const timelineSteps = [
          {
            title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
            datetime: params.timeInside,
            note: params.insideNote
          },
          {
            title: "‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢",
            datetime: params.timeProcess,
            note: params.processNote
          },
          {
            title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô",
            datetime: params.timeStart,
            note: params.startNote
          },
          {
            title: "‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô",
            datetime: params.timeCompress,
            note: params.compressNote
          }
        ];
        timelineSteps.forEach((step, index) => {
          if (step.datetime || step.note) {
            const { date, time } = formatDateTime(step.datetime);
            steps.push({
              type: "box",
              layout: "horizontal",
              margin: "md",
              contents: [
                {
                  type: "box",
                  layout: "vertical",
                  contents: [
                    { type: "text", text: date, size: "sm", color: "#333333", align: "start" },
                    { type: "text", text: time, size: "sm", color: "#333333", align: "start" }
                  ],
                  flex: 2
                },
                {
                  type: "box",
                  layout: "vertical",
                  contents: [
                    {
                      type: "box",
                      layout: "vertical",
                      contents: [],
                      width: "12px",
                      height: "12px",
                      borderWidth: "2px",
                      borderColor: "#1DB446",
                      cornerRadius: "30px",
                      backgroundColor: "#ffffff"
                    },
                    ...(index < timelineSteps.length - 1 ? [{
                      type: "box",
                      layout: "vertical",
                      contents: [],
                      width: "2px",
                      height: "40px",
                      backgroundColor: "#B7B7B7"
                    }] : [])
                  ],
                  flex: 1,
                  alignItems: "center"
                },
                {
                  type: "box",
                  layout: "vertical",
                  contents: [
                    { type: "text", text: step.title, size: "sm", weight: "bold", color: "#000000", wrap: true },
                    { type: "text", text: `üìù ${step.note || '-'}`, size: "sm", color: "#333333", wrap: true }
                  ],
                  flex: 4
                }
              ]
            });
          }
        });
        return steps;
      }

      function formatDateTime(datetime) {
        if (!datetime) return { date: '-', time: '-' };
        const dateObj = new Date(datetime);
        const date = dateObj.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        const time = dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        return { date, time };
      }

      window.operationInitialize = function() {
        operationInitializeLiff();
      };

      window.addEventListener('load', operationInitialize);
    })();
  </script>
</body>
</html>
